<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Silksong 100% Checklist</title>

  <!-- Trajan-like fallback font -->
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&display=swap" rel="stylesheet" />

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="./Weaver.png?v=1" />

  <style>
  @font-face{
    font-family:"Trajan Pro";
    src:
      local("Trajan Pro Regular"),
      local("TrajanPro-Regular"),
      url("TrajanPro-Regular.woff2") format("woff2");
    font-weight:400;
    font-style:normal;
    font-display:swap;
  }

  :root{
    /* Moss grotto palette */
    --fg:#f5fff7;
    --muted:#d9f2de;
    --accent:#62c574;
    --accent2:#a4e3b0;
    --card:#1f3a2a;
    --cardHover:#254530;
    --edge:#2e5a40;
    --edgeStrong:#3f7c57;
    --chip:#1b3225;
    --bar:#182a20;
    --extra1:#78d18a;
    --extra2:#c4f0cc;
    --red:#ffb9b9;
    --blue:#a9cfff;
    --yellow:#ffe39a;

    /* Images (files are in repo ROOT) */
    --bg-image:   url("./Screenshot_SS_Moss_Grotto_01.png?v=1");
    --orn-top:    url("./375px-SS_NPC_Dialogue_Top.png?v=1");
    --orn-bottom: url("./300px-SS_NPC_Dialogue_Bottom.png?v=1");

    /* Small fleur embellishment */
    --fleur-small: url("./completion_top_fleur0004.png");
  }

  *{box-sizing:border-box}
  html,body{
    margin:0;
    color:var(--fg);
    font-family:"Trajan Pro","Cinzel",serif;
    letter-spacing:.2px;
    min-height:100%;
  }

  /* Background with dark green overlay */
  body::before{
    content:"";
    position:fixed; inset:0;
    background:
      linear-gradient(rgba(10,25,18,.68), rgba(10,25,18,.68)),
      var(--bg-image) center/cover no-repeat fixed;
    z-index:-1;
  }

  .container{max-width:1100px;margin:0 auto;padding:1rem}

  /* ===== Centered title with fleurs ===== */
  .titlewrap{
    text-align:center;
    margin:.8rem auto 0;
    display:grid;
    justify-items:center;
    gap:.25rem;
  }
  .titlewrap .fleur{
    width:min(420px,90%);
    height:auto;
    opacity:.96;
    filter:drop-shadow(0 0 1px rgba(0,0,0,.25));
  }
  .titlewrap h1{
    margin:.1rem 0;
    font-size:clamp(1.4rem, 2.5vw + 1rem, 2.2rem);
    letter-spacing:.3px;
  }

  .topbar{
    display:flex;gap:1rem;align-items:center;flex-wrap:wrap;
    border-bottom:2px solid var(--edge);padding-bottom:.75rem;
    backdrop-filter:saturate(120%) blur(2px);
  }

  .controls{display:flex;gap:.5rem;flex-wrap:wrap;margin-left:auto;align-items:center}
  .controls input[type="search"], .controls select{
    padding:.55rem .75rem;background:var(--card);border:1px solid var(--edge);color:var(--fg);border-radius:.55rem
  }
  .controls button{
    padding:.55rem .75rem;background:var(--card);border:1px solid var(--edge);color:var(--fg);
    border-radius:.55rem;cursor:pointer;transition:background .12s,border-color .12s,box-shadow .12s,transform .05s
  }
  .controls button:hover{border-color:var(--edgeStrong);background:var(--cardHover);box-shadow:0 0 0 2px rgba(98,197,116,.18)}
  .controls button:active{transform:translateY(1px)}
  .badge{background:var(--chip);border:1px solid var(--edge);border-radius:.5rem;padding:.25rem .5rem;color:var(--muted);font-size:.8rem}

  /* Segmented filter */
  .seg{display:inline-flex;border:1px solid var(--edge);border-radius:.55rem;overflow:hidden;background:var(--card)}
  .seg button{background:transparent;border:none;padding:.55rem .7rem;color:var(--fg);cursor:pointer}
  .seg button+button{border-left:1px solid var(--edge)}
  .seg button.active{background:var(--cardHover)}

  /* Progress */
  .progress{display:grid;gap:.4rem;margin:.9rem 0}
  .progress .label{color:var(--muted);font-size:.95rem}
  .bar{height:10px;background:var(--bar);border-radius:999px;overflow:hidden;border:1px solid var(--edge)}
  .bar-fill{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2));width:0%}

  /* Cards & items */
  .board{display:grid;gap:1rem}
  .category{
    background:var(--card);border:1px solid var(--edge);border-radius:.9rem;overflow:hidden;
    box-shadow:0 6px 20px rgba(0,0,0,.25);
  }
  .cat-head{
    display:flex;align-items:center;justify-content:space-between;padding:.8rem 1rem;cursor:pointer
  }
  .cat-head h2{
    margin:0;font-size:1.05rem;display:flex;align-items:center;gap:.5rem
  }
  /* Fleur next to category titles */
  .cat-head h2::after{
    content:"";
    width:74px;height:16px;
    background:var(--fleur-small) center/contain no-repeat;
    opacity:.95;
    filter:drop-shadow(0 0 1px rgba(0,0,0,.2));
  }

  .cat-right{display:flex;align-items:center;gap:.35rem;flex-wrap:wrap}
  .pillType{font-size:.7rem;padding:.2rem .45rem;border-radius:.45rem;border:1px solid var(--edge);background:var(--cardHover);color:var(--muted)}
  .cat-count{color:var(--muted);font-size:.85rem;margin-left:.25rem}

  .cat-items{padding:.2rem 1rem 1rem 1rem;display:grid;gap:.25rem}
  .item{display:flex;align-items:center;gap:.6rem;padding:.45rem;border-radius:.6rem;transition:background .12s}
  .item:hover{background:var(--cardHover)}

  /* Make name clickable but not toggling checkbox */
  .namebtn{
    background:none;border:none;color:var(--fg);font:inherit;cursor:pointer;padding:0;
  }
  .namebtn:hover{ text-decoration:underline; }

  .item .meta{margin-left:auto;display:flex;gap:.4rem;align-items:center}
  .item .pill{
    font-size:.75rem;padding:.15rem .45rem;border-radius:.45rem;
    background:var(--cardHover);border:1px solid var(--edge);color:var(--muted)
  }
  .item .color.red{color:var(--red);border-color:var(--red)!important}
  .item .color.blue{color:var(--blue);border-color:var(--blue)!important}
  .item .color.yellow{color:var(--yellow);border-color:var(--yellow)!important}

  .smallbtn,.locbtn{
    font-size:.75rem;padding:.25rem .5rem;border-radius:.45rem;background:var(--cardHover);border:1px solid var(--edge);
    color:var(--muted);cursor:pointer;transition:background .12s,border-color .12s,box-shadow .12s
  }
  .smallbtn:hover,.locbtn:hover{border-color:var(--edgeStrong);background:var(--cardHover);box-shadow:0 0 0 2px rgba(98,197,116,.18)}

  input[type="checkbox"]{ width:18px;height:18px;accent-color:#baf2c4;cursor:pointer; }

  /* Location details (closed by default) */
  .loc{ display:none; grid-column:1/-1; margin:.25rem 0 0 2rem; padding:.85rem .9rem .9rem .9rem;
    border-left:3px solid var(--accent); color:#ecfff0; background:var(--cardHover); border-radius:.4rem; position:relative }
  .loc.open{display:block}
  .loc a{color:#eaffea;text-decoration:underline}

  /* Ornaments (no stretch) */
  .orn{
    width:100%;
    height:22px;
    opacity:.95;
    filter:drop-shadow(0 0 1px rgba(0,0,0,.15));
    background-position:center;
    background-repeat:no-repeat;
    background-size:contain;
    margin:.2rem 0 .6rem 0;
  }
  .orn.top{background-image:var(--orn-top);height:24px}
  .orn.bottom{background-image:var(--orn-bottom);height:20px;margin:.6rem 0 .1rem 0}

  .hidden{display:none!important}
  .footer{margin:1.25rem 0;color:var(--muted);text-align:center;border-top:2px solid var(--edge);padding-top:1rem}
  hr.soft{border:none;border-top:1px dashed var(--edge);margin:.5rem 0}
  .small{font-size:.85rem;color:var(--muted)}

  /* Color subheads (Red/Blue/Yellow) */
  .subhead{
    margin:.5rem 1rem 0;font-size:.85rem;color:#e8ffef;display:flex;align-items:center;gap:.5rem;position:relative
  }
  .dot{width:.6rem;height:.6rem;border-radius:50%}
  .dot.red{background:var(--red)} .dot.blue{background:var(--blue)} .dot.yellow{background:var(--yellow)}
  /* Fleur next to color subheads */
  .subhead::after{
    content:""; margin-left:.4rem;
    width:64px;height:14px;
    background:var(--fleur-small) center/contain no-repeat;
    opacity:.95; filter:drop-shadow(0 0 1px rgba(0,0,0,.2));
  }

  /* Group headers in grouped lists (e.g., Keys/Relics types) */
  .grouphdr{
    display:flex;align-items:center;gap:.5rem;
  }
  .grouphdr::after{
    content:""; width:60px;height:12px;
    background:var(--fleur-small) center/contain no-repeat;
    opacity:.95; filter:drop-shadow(0 0 1px rgba(0,0,0,.2));
  }
  </style>
</head>
<body>
  <div class="container">

    <!-- Centered title with top/bottom fleurs -->
    <div class="titlewrap" aria-label="Title">
      <img class="fleur" src="./Hornet_Title_Fleur_top0007.png" alt="" />
      <h1>Silksong Checklist</h1>
      <img class="fleur" src="./Hornet_Title_Fleur_bot0007.png" alt="" />
    </div>

    <div class="topbar">
      <span id="totalBadge" class="badge">0 items</span>

      <div class="controls">
        <input id="search" type="search" placeholder="Search items…" aria-label="Search" />
        <select id="actFilter" aria-label="Filter by act">
          <option value="all">Act: All / Unknown</option>
        </select>
        <button id="groupByAct" type="button">Group by Act: Off</button>

        <div class="seg" role="group" aria-label="Filter by task type">
          <button id="filterAll"   type="button" class="active">All</button>
          <button id="filterMain"  type="button">100%</button>
          <button id="filterExtra" type="button">Extras</button>
        </div>

        <button id="expandAll" type="button">Expand All</button>
        <button id="collapseAll" type="button">Collapse All</button>
        <button id="exportBtn" type="button">Export</button>
        <input id="importFile" type="file" accept="application/json" hidden>
        <button id="importBtn" type="button">Import</button>
        <button id="resetBtn" type="button">Reset</button>
      </div>
    </div>

    <!-- Weighted -->
    <div class="progress">
      <div class="label">
        <strong><span id="percent">0</span>%</strong> of weighted 100% •
        <span id="doneCount">0</span>/<span id="totalCount">0</span> items checked
      </div>
      <div class="bar"><div id="barFill" class="bar-fill"></div></div>
    </div>

    <!-- Extras -->
    <div class="progress">
      <div class="label small">
        Extras (unweighted): <span id="extrasDone">0</span>/<span id="extrasTotal">0</span> items completed
      </div>
      <div class="bar"><div id="barFillExtras" class="bar-fill" style="background:linear-gradient(90deg,var(--extra1),var(--extra2))"></div></div>
    </div>

    <div id="board" class="board" aria-live="polite"></div>

    <div class="footer">
      <small>Progress is stored locally in your browser (localStorage). No data leaves your device.</small>
    </div>
  </div>

<script>
/* ------ JavaScript (full data + bosses + extras) ------ */
(function() {
  const STORAGE_KEY = "silksong-checklist-v17";
  const HJ_KEY = "hj-count";
  const HJ_TOTAL = 237;

  function ACT_LABEL(a) { return (a || a === 0) ? `Act ${a}` : "Act Unknown"; }

  /* ===== DATA ===== */
  const DATA = [
    /* Needle upgrades (tied to Pale Oil/Pinmaster) */
    { type:"main", name:"Needle Upgrades — 4%", items:[
      {id:"needle_sharpened", name:"Sharpened Needle", weight:1, act:1,
       loc:"Bellhart — free first upgrade from Pinmaster Plinney after freeing Bellhart (defeat Sister Splinter & Widow)."},
      {id:"needle_shining", name:"Shining Needle", weight:1, act:2,
       loc:"Use Pale Oil #1 (Whispering Vaults crate puzzle) at Pinmaster Plinney in Bellhart."},
      {id:"needle_hivesteel", name:"Hivesteel Needle", weight:1, act:2,
       loc:"Use Pale Oil #2 — reward from “Great Taste of Pharloom” quest in Choral Chambers — at Pinmaster Plinney."},
      {id:"needle_pale", name:"Pale Steel Needle", weight:1, act:3,
       loc:"Use Pale Oil #3 — Festival of the Flea reward in Act 3 — at Pinmaster Plinney (after re-freeing him)."}
    ]},

    /* Mask Shards with locations (20) */
    { type:"main", name:"Mask Shards — 5%", items:(function(){
      const LOC = {
        1: "Bone Bottom — buy from Pebb for 300 Rosaries (moves to Grindle in Blasted Steps for 320 if Act 3 starts).",
        2: "Lower Wormways via Mosshome — behind breakable wall before a Simple Key door.",
        3: "Between The Marrow and Deep Docks (enter from The Marrow); Cling Grip recommended.",
        4: "Far Fields — above the Seamstress’s home (needs Drifter’s Cloak).",
        5: "Shellwood — center; end of platforming behind breakable wall.",
        6: "Weavenest Atla (east) — behind breakable wall; Cling Grip.",
        7: "Cogwork Core — route from lower bench to exterior tall room in Choral Chambers.",
        8: "Songclave, Choral Chambers — buy after Wandering Merchant quest.",
        9: "Whispering Vaults — corridor below bench; lift a hidden block mid-way.",
        10:"Mount Fay — near 90-Rosary bench; wall-jump up broken pillar (after Faydown Cloak).",
        11:"Bellhart — complete Savage Beastfly Grand Hunt Wish, deliver claw to Wishwall.",
        12:"Far Fields — skull-house lava room; fight waves then ride the airflow.",
        13:"Blasted Steps — floating platform gauntlet toward next screen.",
        14:"Wisp Thicket — past fire mages; Magma Bell recommended.",
        15:"Bilewater — ‘fish room’ right of Shakra; sprint through then climb.",
        16:"The Slab — Key of the Apostate; complete saw-blade pogo/jump puzzle.",
        17:"Mount Fay (Act 3) — after Silk Soar; hidden icy platforming section.",
        18:"Far Fields (Act 3) — ‘Fastest in Pharloom’ Wish; win three races.",
        19:"Bellhart (Act 3) — ‘Dark Hearts’ Wish; defeat 12 Void Masses.",
        20:"Bellhart (Act 3) — ‘The Hidden Hunter’ Wish; return with Grass Doll."
      };
      const arr = [];
      for (let k = 0; k < 20; k++) {
        const n = k+1;
        const act = (n <=6) ? 1 : (n <=16 ? 2 : 3);
        arr.push({ id:`maskShard_${n}`, name:`Mask Shard ${n}`, weight:0.25, act, loc: LOC[n] });
      }
      return arr;
    })() },

    /* Spool Fragments with locations (18) */
    { type:"main", name:"Spool Fragments — 9%", items:(function(){
      const LOC = {
        1: "Mossy area above Bone Bottom — behind a breakable wall.",
        2: "Deep Docks central — flip a lever then climb back up to reach ledge.",
        3: "Greymoor above Shakra’s bench — Cling Grip balloon chamber.",
        4: "Bellhart — sold by Frey for 270 Rosaries (after My Missing Courier).",
        5: "Weavenest Atla — west path via Needolin room; hidden drop.",
        6: "The Slab — from Bellway station, up through cages to ceiling passage (Cling Grip).",
        7: "Grand Gate — tip the hanging scales with upward strikes.",
        8: "Underworks — west combat gauntlet below Ventrica station.",
        9: "Flea Caravan — awarded when Caravan ascends to Grand Gate (12 Fleas + Last Judge).",
        10:"Whiteward — under the lift; call it, drop and enter side passage.",
        11:"Cogwork Core (SE) — after a combat gauntlet eastward.",
        12:"Underworks (lower right) — break left wall in burning floor room from The Cauldron shaft.",
        13:"Sherma reward — complete Balm For The Wounded Wish.",
        14:"Jubilana shop — 500 Rosaries (after The Lost Merchant).",
        15:"Deep Docks SE — open gate with Clawline, break explosive rock, platform through hazards.",
        16:"High Halls — top of left vertical (Faydown Cloak + Clawline) or via Silk Soar.",
        17:"Memorium (west) — from 4F below Ventrica, break vines south and circle around spikes.",
        18:"Grindle shop — 680 Rosaries (needs Faydown Cloak + Cling Grip)."
      };
      const arr = [];
      for (let k = 0; k < 18; k++) {
        const n = k+1;
        const act = (n <=6) ? 1 : 2;
        arr.push({ id:`spoolFrag_${n}`, name:`Spool Fragment ${n}`, weight:0.5, act, loc: LOC[n] });
      }
      return arr;
    })() },

    /* Crafting Kit Upgrades — vendors & quest rewards */
    { type:"main", name:"Crafting Kit Upgrades — 4%", items:[
      {id:"kit_1", name:"Crafting Kit Expansion I", weight:1, act:1,
       loc:"Deep Docks — buy from the Forge Daughter after opening her shop."},
      {id:"kit_2", name:"Crafting Kit Expansion II", weight:1, act:1,
       loc:"Reward for completing the Crawbug Clearing Wish "},
      {id:"kit_3", name:"Crafting Kit Expansion III", weight:1, act:2,
       loc:"Bought from Twelfth Architect in Underworks for  450 | Requires Clawline."},
      {id:"kit_4", name:"Crafting Kit Expansion IV", weight:1, act:2,
       loc:"Bought from Grindle in Blasted Steps for  700 | Requires Faydown Cloak."}
    ]},

    /* Tool Pouch Upgrades — capacity vendors */
    { type:"main", name:"Tool Pouch Upgrades — 4%", items:[
      {id:"pouch_1", name:"Tool Pouch Expansion I", weight:1, act:1,
       loc:"Bought from Mort in Far Fields for  220 (Act 1/2) / Bought from Grindle in Blasted Steps for  220 (Act 3) "},
      {id:"pouch_2", name:"Tool Pouch Expansion II", weight:1, act:1,
       loc:"Received from Loddie in the The Marrow for beating his first challenge (Act 1/2) / Found in Loddie's former location, on a table (Act 3)"},
      {id:"pouch_3", name:"Tool Pouch Expansion III", weight:1, act:2,
       loc:"Complete Nuu's Wish: Bugs of Pharloom"},
      {id:"pouch_4", name:"Tool Pouch Expansion IV", weight:1, act:2,
       loc:"Reward from Mooshka after helping the Flea Caravan move to Putrified Ducts"}
    ]},

    /* Crests — chapels & quests */
    { type:"main", name:"Crests — 6%", items:[
      {id:"crest_reaper", name:"Reaper", weight:1, act:1,
       loc:"Greymoor — Chapel of the Reaper at far west; clear gauntlet and claim the crest."},
      {id:"crest_wanderer", name:"Wanderer", weight:1, act:1,
       loc:"Bonegrave/Moss Grotto — Chapel of the Wanderer."},
      {id:"crest_beast", name:"Beast", weight:1, act:1,
       loc:"Hunter’s March — Chapel of the Beast in Hunters March"},
      {id:"crest_witch", name:"Witch", weight:1, act:2,
       loc:"Complete “Rite of Rebirth” then “Infestation Operation,” return to Chapel of the Witch."},
      {id:"crest_architect", name:"Architect", weight:1, act:2,
       loc:"Buy from Twelfth Architect in Underworks"},
      {id:"crest_shaman", name:"Shaman", weight:1, act:3,
       loc:"The Shaman Crest can be obtained from the Ruined Chapel in Moss Grotto, requiring the Silk Soar ability to reach."}
    ]},

    /* Silk Skills — statues & bosses */
    { type:"main", name:"Silk Skills — 6%", items:[
      {id:"skill_silkspear", name:"Silkspear", weight:1, act:1,
       loc:"Mosshome — early statue (top of Mosshome from Bone Bottom path)."},
      {id:"skill_threadstorm", name:"Thread Storm", weight:1, act:1,
       loc:"Greymoor — early unlock via statue/quest; strong AoE spinner."},
      {id:"skill_sharpdart", name:"Sharpdart", weight:1, act:1,
       loc:"Exhaust Organ (Bilewater line) — defeat Phantom to learn counter-technique."},
      {id:"skill_crossstitch", name:"Cross Stitch", weight:1, act:1,
       loc:"Statue/quest room near early Mosshome routes; unlocks mid-Act 1."},
      {id:"skill_runerage", name:"Rune Rage", weight:1, act:1,
       loc:"Reward from early combat trial/NPC instructor off The Marrow central shaft."},
      {id:"skill_purenails", name:"Pure Nails", weight:1, act:3,
       loc:"Act 3 — advanced statue after Silk Soar, in path to the Abyss/Grand Gate."}
    ]},

    /* TOOLS — each with a brief where-to-get */
    { type:"main", name:"Tools — 51%", items:[
      /* RED — Act 1 */
      {id:"tool_straightpin",  name:"Straight Pin",   weight:1, act:1, color:"red",
       loc:"The Marrow — far-right prison cells; free Grindle and climb to the glow."},
      {id:"tool_threefold",    name:"Threefold Pin",  weight:1, act:1, color:"red",
       loc:"Hunter’s March — found along chapel approach side-room chest."},
      {id:"tool_longpin",      name:"Longpin",        weight:1, act:1, color:"red",
       loc:"Moss Grotto — platforming alcove above Bone Bottom."},
      {id:"tool_curveclaw",    name:"Curveclaw / Curvesickle", weight:1, act:1, color:"red",
       loc:"Hunter’s March — path toward Chapel of the Beast; upgrade in Act 3."},
      {id:"tool_tacks",        name:"Tacks",          weight:1, act:1, color:"red",
       loc:"Shellwood — side chamber behind a brittle wall."},
      {id:"tool_stingshard",   name:"Sting Shard",    weight:1, act:1, color:"red",
       loc:"The Marrow — drop-room left of central shaft mid-levels."},
      {id:"tool_pimpillo",     name:"Pimpillo",       weight:1, act:1, color:"red",
       loc:"Moss Grotto — reward from a brief mushroom nest gauntlet."},
      {id:"tool_flintslate",   name:"Flintslate",     weight:1, act:1, color:"red",
       loc:"The Marrow — small room along the long vertical drop (mid)."},
      {id:"tool_plasmium",     name:"Plasmium Phial", weight:1, act:1, color:"red",
       loc:"Moss Grotto — vendor stock after opening Weavenest power."},
      {id:"tool_fleabrew",     name:"Flea Brew",      weight:1, act:1, color:"red",
       loc:"Greymoor — Flea festival vendor (Act 1 stock)."},
      /* RED — Act 2 */
      {id:"tool_silkshot",     name:"Silkshot",       weight:1, act:2, color:"red",
       loc:"Bilewater lower-right — cocoon door; play Needolin to reach Weavenest Murglin and repair the tool."},
      {id:"tool_throwingring", name:"Throwing Ring",  weight:1, act:2, color:"red",
       loc:"Choral Chambers — training annex chest after mini-trial."},
      {id:"tool_conchcutter",  name:"Conchcutter",    weight:1, act:2, color:"red",
       loc:"Sands of Karak — path toward Coral Tower gate challenge."},
      {id:"tool_delverdrill",  name:"Delver’s Drill", weight:1, act:2, color:"red",
       loc:"Deep Docks — delver hideout cache after switch sequence."},
      {id:"tool_cogwheel",     name:"Cogwork Wheel",  weight:1, act:2, color:"red",
       loc:"Cogwork Core — puzzle room near gearing lifts."},
      {id:"tool_voltvessels",  name:"Voltvessels",    weight:1, act:2, color:"red",
       loc:"Sands of Karak — Voltnest side cavern reward."},
      {id:"tool_cogfly",       name:"Cogfly",         weight:1, act:2, color:"red",
       loc:"Cogwork Core — secret in fan-shaft side path."},
      {id:"tool_rosarycannon", name:"Rosary Cannon",  weight:1, act:2, color:"red",
       loc:"Whispering Vaults — hidden cache beyond choir balcony."},

      /* BLUE — Act 1 */
      {id:"tool_druidseye",    name:"Druid’s Eye / Druid’s Eyes", weight:1, act:1, color:"blue",
       loc:"Mosshome — complete ‘Berry Picking’ for the Moss Druid (extra berries further empower it)."},
      {id:"tool_magmbell",     name:"Magma Bell",          weight:1, act:1, color:"blue",
       loc:"Wisp Thicket — heat shrine chest after flame trial."},
      {id:"tool_wardingbell",  name:"Warding Bell",        weight:1, act:1, color:"blue",
       loc:"Greymoor — chapel side-crypt, post-gauntlet chest."},
      {id:"tool_pollip",       name:"Pollip Pouch",        weight:1, act:1, color:"blue",
       loc:"Shellwood — complete ‘Rite of the Pollip’ collection."},
      {id:"tool_fracturedmask",name:"Fractured Mask",      weight:1, act:1, color:"blue",
       loc:"Hunter’s March — chapel approach alcove (platforming)."},
      {id:"tool_multibinder",  name:"Multibinder",         weight:1, act:1, color:"blue",
       loc:"Far Fields — Pilgrim’s Rest side room chest."},
      {id:"tool_weavelight",   name:"Weavelight",          weight:1, act:1, color:"blue",
       loc:"Weavenest Atla — power up the area; west of the bench."},

      /* BLUE — Act 2 */
      {id:"tool_sawtooth",     name:"Sawtooth Circlet",    weight:1, act:2, color:"blue",
       loc:"Deep Docks — high scaffolding stash (requires Cling Grip)."},
      {id:"tool_injectorband", name:"Injector Band",       weight:1, act:2, color:"blue",
       loc:"Whiteward — medical ward side lab locker."},
      {id:"tool_spoolext",     name:"Spool Extender",      weight:1, act:2, color:"blue",
       loc:"Underworks — near Ventrica station puzzle room."},
      {id:"tool_reservebind",  name:"Reserve Bind",        weight:1, act:2, color:"blue",
       loc:"High Halls — reward from Final Audience questline."},
      {id:"tool_clawmirror",   name:"Claw Mirror",         weight:1, act:2, color:"blue",
       loc:"Whispering Vaults — stage room after Trobbio encounter."},
      {id:"tool_memorycrystal",name:"Memory Crystal",      weight:1, act:2, color:"blue",
       loc:"Choral Chambers — study with archivist puzzle."},
      {id:"tool_snitchpick",   name:"Snitch Pick",         weight:1, act:2, color:"blue",
       loc:"Deep Docks — hidden vault behind breakable wall."},
      {id:"tool_voltfilament", name:"Volt Filament",       weight:1, act:2, color:"blue",
       loc:"Sands of Karak — Voltnest core after event."},
      {id:"tool_quicksling",   name:"Quick Sling",         weight:1, act:2, color:"blue",
       loc:"Choral Chambers — arena challenge reward."},
      {id:"tool_wreathpurity", name:"Wreath of Purity",    weight:1, act:2, color:"blue",
       loc:"Whiteward — chapel reliquary chest."},
      {id:"tool_longclaw",     name:"Longclaw",            weight:1, act:2, color:"blue",
       loc:"Deep Docks — long jump route past gears (Clawline)."},
      {id:"tool_wispfire",     name:"Wispfire Lantern",    weight:1, act:2, color:"blue",
       loc:"Wisp Thicket — reward after fire-wisp escort."},
      {id:"tool_eggflealia",   name:"Egg of Flealia",      weight:1, act:2, color:"blue",
       loc:"Greymoor — Flea Caravan favor chain."},

      /* BLUE — Act 3 */
      {id:"tool_pinbadge",     name:"Pin Badge",           weight:1, act:3, color:"blue",
       loc:"Mount Fay — reward from Pinstress encounter."},

      /* YELLOW — Act 1 */
      {id:"tool_compass",      name:"Compass",             weight:1, act:1, color:"yellow",
       loc:"The Marrow — buy from Shakra, the map vendor (she relocates as you progress)."},
      {id:"tool_shardpendant", name:"Shard Pendant",       weight:1, act:1, color:"yellow",
       loc:"The Marrow — small side room left of the central shaft (mid)."},
      {id:"tool_magnetite_brooch", name:"Magnetite Brooch", weight:1, act:1, color:"yellow",
       loc:"Bone Bottom — buy from Pebb for ~120 Rosaries."},
      {id:"tool_weightedbelt", name:"Weighted Belt",       weight:1, act:1, color:"yellow",
       loc:"Greymoor — chapel approach cache."},
      {id:"tool_barbed",       name:"Barbed Bracelet",     weight:1, act:1, color:"yellow",
       loc:"Moss Grotto — hidden nook beyond brittle wall."},
      {id:"tool_deadbug",      name:"Dead Bug’s Purse / Shell Satchel", weight:1, act:1, color:"yellow",
       loc:"Moss Grotto — vendor stock near Bone Bottom."},
      {id:"tool_silkspeed",    name:"Silkspeed Anklets",   weight:1, act:1, color:"yellow",
       loc:"Far Fields — race reward/trader stock in Pilgrim’s Rest."},
      {id:"tool_thiefsmark",   name:"Thief’s Mark",        weight:1, act:1, color:"yellow",
       loc:"The Marrow — cellblock side room, locked chest."},

      /* YELLOW — Act 2 */
      {id:"tool_magnetite_dice", name:"Magnetite Dice",    weight:1, act:2, color:"yellow",
       loc:"Bellhart — gambler NPC reward/shop after side quest."},
      {id:"tool_scuttlebrace", name:"Scuttlebrace",        weight:1, act:2, color:"yellow",
       loc:"Deep Docks — crate yard secret under scaffolds."},
      {id:"tool_wallcling",    name:"Ascendant’s Grip",    weight:1, act:2, color:"yellow",
       loc:"Choral Chambers — wall-run trial prize."},
      {id:"tool_spiderstrings",name:"Spider Strings",      weight:1, act:2, color:"yellow",
       loc:"Weavenest Atla — post-power challenge chest."}
    ]},

    /* Silk Hearts */
    { type:"main", name:"Silk Hearts — 3%", items:[
      {id:"sheart_1", name:"Silk Heart I", weight:1, act:1,
       loc:"Bell Beast path — unlock Bellways then collect heart shard in early Act 1 hub."},
      {id:"sheart_2", name:"Silk Heart II", weight:1, act:2,
       loc:"The Cradle — reward during mid-Act 2 ascent path (Lace rematch route)."},
      {id:"sheart_3", name:"Silk Heart III", weight:1, act:2,
       loc:"Harmonic/Whispering/Memory sectors — the three orbs route spanning Act 2 zones."}
    ]},

    /* Misc */
    { type:"main", name:"Miscellaneous — 2%", items:[
      {id:"misc_sylphsong", name:"Sylphsong", weight:1, act:2,
       loc:"Moss Grotto — Weavenest Atla (Eva). Use Needolin to enter, restore power, then bind Eva."},
      {id:"misc_everbloom", name:"Everbloom", weight:1, act:3,
       loc:"Moss Grotto — reward after completing ‘Old Hearts’ Wish chain in Act 3."}
    ]},

    /* ================== EXTRAS (unchanged structure; still trackable) ================== */
    { type:"extra", name:"Boss Fights", items:[
      {id:"boss_moss_mother",      name:"Moss Mother",            act:1, loc:"Moss Grotto"},
      {id:"boss_bell_beast",       name:"Bell Beast",             act:1, loc:"The Marrow • unlocks Bellways + Silk Heart"},
      {id:"boss_lace_a1",          name:"Lace",                   act:1, loc:"Deep Docks (after Swift Step)"},
      {id:"boss_fourth_chorus",    name:"Fourth Chorus",          act:1, loc:"Far Fields (after Drifter’s Cloak)"},
      {id:"boss_sister_splinter",  name:"Sister Splinter",        act:1, loc:"Shellwood"},
      {id:"boss_widow_bellhart",   name:"Widow Bellhart",         act:1, loc:"—"},
      {id:"boss_last_judge",       name:"Last Judge",             act:1, loc:"Blasted Steps • Gate to Citadel / Act 2"},

      {id:"boss_moorwing",         name:"Moorwing",               act:1, loc:"Greymoor (south-west)"},
      {id:"boss_savage_beastfly_a1",name:"Savage Beastfly",       act:1, loc:"Hunter’s March, Chapel of the Beast • Beast Crest"},
      {id:"boss_skull_tyrant",     name:"Skull Tyrant",           act:1, loc:"The Marrow • via ‘Terrible Tyrant’ Wish"},
      {id:"boss_moss_mother_duo",  name:"Moss Mother Duo",        act:1, loc:"Weavenest Atla • west of bench • Weavelight Tool"},
      {id:"boss_great_conchflies", name:"Great Conchflies",       act:1, loc:"Blasted Steps • path to Citadel/Sands"},
      {id:"boss_phantom",          name:"Phantom",                act:1, loc:"Exhaust Organ (via The Mist) • Cross Stitch"},
      {id:"boss_craggler",         name:"Craggler",               act:1, loc:"The Marrow"},
      {id:"boss_skarrgard",        name:"Skarrgard",              act:1, loc:"Hunter’s March"},
      {id:"boss_disgraced_chef_lugoli", name:"Disgraced Chef Lugoli", act:1, loc:"Sinner’s Road"},

      {id:"boss_cogwork_dancers",  name:"Cogwork Dancers",        act:2, loc:"Cogwork Core • starts Threefold Song"},
      {id:"boss_lace_rematch",     name:"Lace (rematch)",         act:2, loc:"The Cradle • Silk Heart"},
      {id:"boss_grand_mother_silk",name:"Grand Mother Silk",      act:2, loc:"The Cradle"},

      {id:"boss_trobbio",          name:"Trobbio",                act:2, loc:"Whispering Vaults, The Stage"},
      {id:"boss_savage_beastfly_a2",name:"Savage Beastfly (rematch)",act:2, loc:"Far Fields • Mask Shard"},
      {id:"boss_groal_the_great",  name:"Groal the Great",        act:2, loc:"Bilewater • access Seeker’s Soul"},
      {id:"boss_broodmother",      name:"Broodmother",            act:2, loc:"The Slab • ‘Wailing Mother’ Wish"},
      {id:"boss_disgraced_chef_lugosi", name:"Disgraced Chef Lugosi", act:2, loc:"Sinner’s Road (Double Jump)"},
      {id:"boss_forebrothers",     name:"Forebrothers Signis & Gron", act:2, loc:"Deep Docks • Simple Key door"},
      {id:"boss_raging_conchfly",  name:"Raging Conchfly",        act:2, loc:"Sands of Karak • access Coral Tower"},
      {id:"boss_father_of_the_flame", name:"Father of the Flame", act:2, loc:"Wisp Thicket"},
      {id:"boss_second_sentinel",  name:"Second Sentinel",        act:2, loc:"High Halls • ‘Final Audience’"},
      {id:"boss_garmond_zaza",     name:"Garmond & Zaza",         act:2, loc:"Whispering Vaults • hidden room"},
      {id:"boss_shakra",           name:"Shakra",                 act:2, loc:"Greymoor • ‘Trail’s End’ Wish"},
      {id:"boss_unravelled",       name:"The Unravelled",         act:2, loc:"Whiteward • Surgeon’s Key"},
      {id:"boss_first_sinner",     name:"First Sinner",           act:2, loc:"The Slab • Key of the Apostate"},
      {id:"boss_voltvyrm",         name:"Voltvyrm",               act:2, loc:"Voltnest, Sands of Karak"},
      {id:"boss_watcher_at_the_edge", name:"Watcher at the Edge", act:2, loc:"Sands of Karak • hidden nook"},

      {id:"boss_shrine_guardian_seth", name:"Shrine Guardian Seth", act:3, loc:"Grand Gate (west passage)"},
      {id:"boss_nyleth",           name:"Nyleth",                 act:3, loc:"Grand Gate • Elegy of the Deep"},
      {id:"boss_crust_king_khann", name:"Crust King Khann",       act:3, loc:"Coral Tower, Sands of Karak"},
      {id:"boss_skarrsinger_karmelita", name:"Skarrsinger Karmelita", act:3, loc:"Far Fields • Silk Soar path"},
      {id:"boss_lost_lace",        name:"Lost Lace",              act:3, loc:"The Abyss • after Old Hearts + Everbloom"},

      {id:"boss_bell_eater",       name:"Bell Eater",             act:3, loc:"The Marrow"},
      {id:"boss_crawfather",       name:"Crawfather",             act:3, loc:"Craw Lake, Greymoor"},
      {id:"boss_lost_garmond",     name:"Lost Garmond",           act:3, loc:"Blasted Steps"},
      {id:"boss_plasmified_zango", name:"Plasmified Zango",       act:3, loc:"Wormways"},
      {id:"boss_tormented_trobbio",name:"Tormented Trobbio",      act:3, loc:"The Stage"},
      {id:"boss_pinstress",        name:"Pinstress",              act:3, loc:"Mount Fay"},
      {id:"boss_summoned_savior",  name:"Summoned Savior",        act:3, loc:"Moss Grotto (Steel Mode)"},
      {id:"boss_palestag",         name:"Palestag",               act:3, loc:"Verdania"},
      {id:"boss_clover_dancers",   name:"Clover Dancers",         act:3, loc:"Verdania"},
      {id:"boss_watcher_at_the_end", name:"Watcher at the End",   act:3, loc:"Sands of Karak • near Memory Locket"},
    ]},

    /* Wishes, Materium, Journal, Keys, Relics, etc. left as extras */
    { type:"extra", name:"Wishes", items:(()=>{const a=[];for(let i=1;i<=73;i++) a.push({id:`wish_${i}`, name:`Wish ${i}`, act:null}); return a;})() },
    { type:"extra", name:"The Materium", items:[ {id:"materium_placeholder1", name:"Materium Entry — TBD", act:null} ]},
    { type:"extra", name:"Hunter Journal", items:[ {id:"hj_condensed", name:`${HJ_TOTAL} entries (use the counter below)`, act:null, condensed:true} ]},
    { type:"extra", name:"Keys", items:(()=>{const items=[];for(let i=1;i<=4;i++) items.push({id:`key_simple_${i}`, name:`Simple Key ${i}`, act:null, group:"Simple Keys"});for(let i=1;i<=3;i++) items.push({id:`key_slab_${i}`, name:`Slab Key ${i}`, act:null, group:"Slab Keys"});for(let i=1;i<=4;i++) items.push({id:`key_misc_${i}`, name:`Misc Key ${i}`, act:null, group:"Misc Keys"});return items;})() },
    { type:"extra", name:"Relics", items:(()=>{const add=(arr,c,base,group)=>{for(let i=1;i<=c;i++) arr.push({id:`relic_${base.toLowerCase().replace(/\s+/g,'_')}_${i}`, name:`${base} ${i}`, act:null, group});};const out=[];add(out,6,"Cylinder","Cylinders");add(out,4,"Choral Commandment","Choral Commandments");add(out,3,"Weaver Effigy","Weaver Effigy");add(out,4,"Bone Scroll","Bone Scroll");add(out,3,"Rune Harp","Rune Harp");add(out,1,"Arcane Egg","Arcane Egg");return out;})() },
    { type:"extra", name:"Mementos", items:[
      {id:"mem_hunter", name:"Hunter’s Memento", act:3},
      {id:"mem_grey", name:"Grey Memento", act:3},
      {id:"mem_guardian", name:"Guardian’s Memento", act:3},
      {id:"mem_sprintmaster", name:"Sprintmaster’s Memento", act:3},
      {id:"mem_craw", name:"Craw Memento", act:3},
      {id:"mem_hero", name:"Hero’s Memento", act:3},
      {id:"mem_surface", name:"Surface Memento", act:3},
      {id:"mem_pollenheart", name:"Pollen Heart", act:3},
      {id:"mem_encrustedheart", name:"Encrusted Heart", act:3},
      {id:"mem_huntersheart", name:"Hunter’s Heart", act:3},
      {id:"mem_conjoinedheart", name:"Conjoined Heart", act:3},
    ]},
    { type:"extra", name:"Memory Lockets", items:(()=>{const a=[];for(let i=1;i<=20;i++) a.push({id:`locket_${i}`, name:`Memory Locket ${i}`, act:null}); return a;})() },
    { type:"extra", name:"Fleas", items:(()=>{const a=[];for(let i=1;i<=30;i++) a.push({id:`flea_${i}`, name:`Flea ${i}`, act:null}); return a;})() },
    { type:"extra", name:"Pail Oil", items:[ {id:"oil_1", name:"Pail Oil 1", act:null},{id:"oil_2", name:"Pail Oil 2", act:null},{id:"oil_3", name:"Pail Oil 3", act:null} ]},
    { type:"extra", name:"Craft Metal", items:(()=>{const a=[];for(let i=1;i<=8;i++) a.push({id:`metal_${i}`, name:`Craft Metal ${i}`, act:null}); return a;})() }
  ];

  /* ===== Order indices for stable sort ===== */
  const categoryIndex = new Map();
  const itemIndex = new Map();
  (function buildOrder() {
    let c = 0, i = 0;
    for (const cat of DATA) {
      if (!categoryIndex.has(cat.name)) categoryIndex.set(cat.name, c++);
      for (const it of cat.items) itemIndex.set(it.id, i++);
    }
  })();

  /* ===== DOM refs ===== */
  const board = document.getElementById("board");
  const searchEl = document.getElementById("search");
  const actFilterEl = document.getElementById("actFilter");
  const doneCountEl = document.getElementById("doneCount");
  const totalCountEl = document.getElementById("totalCount");
  const percentEl = document.getElementById("percent");
  const barFillEl = document.getElementById("barFill");
  const extrasDoneEl = document.getElementById("extrasDone");
  const extrasTotalEl = document.getElementById("extrasTotal");
  const barFillExtrasEl = document.getElementById("barFillExtras");
  const totalBadge = document.getElementById("totalBadge");

  const expandAllBtn = document.getElementById("expandAll");
  const collapseAllBtn = document.getElementById("collapseAll");
  const exportBtn = document.getElementById("exportBtn");
  const importBtn = document.getElementById("importBtn");
  const importFile = document.getElementById("importFile");
  const resetBtn = document.getElementById("resetBtn");
  const groupBtn = document.getElementById("groupByAct");
  const filterAllBtn = document.getElementById("filterAll");
  const filterMainBtn = document.getElementById("filterMain");
  const filterExtraBtn = document.getElementById("filterExtra");

  /* ===== State ===== */
  let checked = new Set(JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]"));
  let hjCount = Number(localStorage.getItem(HJ_KEY) || "0");
  let groupByAct = false;
  let filterType = "all";

  function persist() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(Array.from(checked)));
    localStorage.setItem(HJ_KEY, String(hjCount));
  }

  function flatItems(){
    const list = [];
    for (const cat of DATA) {
      for (const it of cat.items) {
        list.push({...it, category: cat.name, type: cat.type});
      }
    }
    return list;
  }

  /* Act dropdown */
  (function initActFilter(){
    const acts = new Set(flatItems().map(i => i.act).filter(a => a !== null && a !== undefined));
    Array.from(acts).sort((a,b)=>a-b).forEach(a => {
      const opt = document.createElement("option");
      opt.value = String(a);
      opt.textContent = ACT_LABEL(a);
      actFilterEl.appendChild(opt);
    });
  })();

  function sectionTitle(text){
    const d = document.createElement("div");
    d.textContent = text;
    d.style.margin = ".25rem 0 .5rem";
    d.style.color = "var(--muted)";
    d.style.fontSize = ".95rem";
    return d;
  }

  function subHead(txt, color){
    const sh = document.createElement("div");
    sh.className = "subhead";
    const dot = document.createElement("span"); dot.className = "dot " + color;
    const label = document.createElement("span"); label.textContent = txt;
    sh.append(dot, label);
    return sh;
  }

  function renderItems(container, items) {
    // Detect if this category wants grouping (by `group` label)
    const hasGroup = items.some(x => x.group);
    if (hasGroup) {
      const byGroup = {};
      items.forEach(it => {
        const g = it.group || "Other";
        (byGroup[g] ||= []).push(it);
      });
      Object.keys(byGroup).forEach(gname => {
        const hdr = document.createElement("div");
        hdr.className = "small grouphdr";
        hdr.style.margin = ".5rem 0 .25rem";
        hdr.textContent = gname;
        container.appendChild(hdr);
        renderItemsList(container, byGroup[gname]);
      });
    } else {
      renderItemsList(container, items);
    }
  }

  /* ===== Item rows (name click only toggles location, not checkbox) ===== */
  function renderItemsList(container, items){
    for (const it of items) {
      if (it.condensed) {
        // Special Hunter Journal compact control
        const wrap = document.createElement("div");
        wrap.className = "item";
        const label = document.createElement("div");
        label.textContent = `Hunter Journal progress: `;
        const meta = document.createElement("div"); meta.className="meta";

        const count = document.createElement("span"); count.className="pill"; count.id="hjCount"; count.textContent = `${hjCount}/${HJ_TOTAL}`;
        const minus = document.createElement("button"); minus.type="button"; minus.className="smallbtn"; minus.textContent = "–";
        const plus = document.createElement("button"); plus.type="button"; plus.className="smallbtn"; plus.textContent = "+";
        const reset = document.createElement("button"); reset.type="button"; reset.className="smallbtn"; reset.textContent = "Reset";

        function updateHJ(delta){
          hjCount = Math.max(0, Math.min(HJ_TOTAL, hjCount + delta));
          document.getElementById("hjCount").textContent = `${hjCount}/${HJ_TOTAL}`;
          persist(); updateTotals();
        }
        minus.addEventListener("click", ()=>updateHJ(-1));
        plus.addEventListener("click", ()=>updateHJ(+1));
        reset.addEventListener("click", ()=>{ hjCount=0; document.getElementById("hjCount").textContent = `${hjCount}/${HJ_TOTAL}`; persist(); updateTotals(); });

        meta.append(count, minus, plus, reset);
        wrap.append(label, meta);
        container.appendChild(wrap);

        // Collapsible info (manual toggle only)
        const details = document.createElement("div"); details.className="loc";
        const ornTop = document.createElement("div"); ornTop.className="orn top";
        const ornBottom = document.createElement("div"); ornBottom.className="orn bottom";
        const body = document.createElement("div"); body.innerHTML = "Tip: Use this counter to track total entries without listing all 237.";
        details.append(ornTop, body, ornBottom);

        const locBtn = document.createElement("button"); locBtn.type="button"; locBtn.className="locbtn"; locBtn.textContent = "ℹ Notes";
        locBtn.addEventListener("click", ()=>details.classList.toggle("open"));
        const meta2 = document.createElement("div"); meta2.style.marginLeft="auto"; meta2.appendChild(locBtn);
        wrap.appendChild(meta2);
        container.appendChild(details);

        continue;
      }

      const row = document.createElement("div"); row.className = "item";

      // Checkbox only toggles completion when clicked directly
      const cb = document.createElement("input");
      cb.type = "checkbox"; cb.id = it.id; cb.checked = checked.has(it.id);

      // Name acts like a button: opens/closes location only
      const nameBtn = document.createElement("button");
      nameBtn.type = "button";
      nameBtn.className = "namebtn";
      nameBtn.textContent = it.name;

      const meta = document.createElement("div"); meta.className = "meta";
      if (it.weight != null) {
        const w = document.createElement("span"); w.className = "pill"; w.textContent = `${it.weight}%`;
        meta.appendChild(w);
      }
      const a = document.createElement("span"); a.className = "pill"; a.textContent = ACT_LABEL(it.act);
      meta.appendChild(a);
      if (it.color) {
        const c = document.createElement("span"); c.className = `pill color ${it.color}`; c.textContent = it.color.charAt(0).toUpperCase() + it.color.slice(1);
        meta.appendChild(c);
      }
      const locBtn = document.createElement("button"); locBtn.type = "button"; locBtn.className = "locbtn"; locBtn.textContent = "📍 Location";
      meta.appendChild(locBtn);

      // Location details
      const details = document.createElement("div"); details.className = "loc";
      const ornTop = document.createElement("div"); ornTop.className = "orn top";
      const ornBottom = document.createElement("div"); ornBottom.className = "orn bottom";
      const body = document.createElement("div");
      body.innerHTML = (it.loc || "Location info not added yet.") + (it.url ? ` — <a target="_blank" rel="noopener" href="${it.url}">Open</a>` : "");
      details.append(ornTop, body, ornBottom);

      function toggleDetails() { details.classList.toggle("open"); }
      nameBtn.addEventListener("click", toggleDetails);
      locBtn.addEventListener("click", toggleDetails);

      cb.addEventListener("change", () => {
        if (cb.checked) checked.add(it.id);
        else checked.delete(it.id);
        persist();
        updateTotals();
      });

      row.append(cb, nameBtn, meta);
      container.append(row, details);
    }
  }

  function updateCatCount(el, items){
    const done = items.filter(i => !i.condensed && checked.has(i.id)).length; // condensed not counted per-item
    el.textContent = `${done}/${items.filter(i=>!i.condensed).length}`;
  }

  function groupBy(list, key) {
    const out = {};
    for (const it of list) {
      const k = it[key];
      if (!out[k]) out[k] = [];
      out[k].push(it);
    }
    return out;
  }

  function render(){
    board.innerHTML = "";
    const items = flatItems();
    totalBadge.textContent = `${items.length} items`;

    const term = (searchEl.value || "").trim().toLowerCase();
    const actFilter = actFilterEl.value;

    const visible = items.filter(it => {
      const s = it.name.toLowerCase();
      const matchesSearch = !term || s.includes(term) || it.category.toLowerCase().includes(term) || (it.group||"").toLowerCase().includes(term);
      const matchesAct = actFilter === "all" || String(it.act) === actFilter;
      let matchesType = true;
      if (filterType === "main") matchesType = it.type === "main";
      else if (filterType === "extra") matchesType = it.type !== "main";
      return matchesSearch && matchesAct && matchesType;
    });

    if (groupByAct) {
      const byAct = {};
      for (const it of visible) {
        const k = it.act == null ? "Unknown" : it.act;
        (byAct[k] ||= []).push(it);
      }
      const keys = Object.keys(byAct).sort((a,b) => {
        if (a === "Unknown") return 1;
        if (b === "Unknown") return -1;
        return Number(a) - Number(b);
      });
      for (const k of keys) {
        const title = k === "Unknown" ? "Act Unknown" : `Act ${k}`;
        board.appendChild(sectionTitle(title));
        const byCat = groupBy(byAct[k], "category");
        Object.keys(byCat)
          .sort((a,b) => (categoryIndex.get(a) ?? 9999) - (categoryIndex.get(b) ?? 9999))
          .forEach(catName => {
            const arr = byCat[catName].slice().sort((a,b) => (itemIndex.get(a.id) ?? 999999) - (itemIndex.get(b.id) ?? 999999));
            board.appendChild(renderCategory(catName, arr));
          });
        const hr = document.createElement("hr"); hr.className="soft";
        board.appendChild(hr);
      }
    } else {
      const byCat = groupBy(visible, "category");
      Object.keys(byCat)
        .sort((a,b) => (categoryIndex.get(a) ?? 9999) - (categoryIndex.get(b) ?? 9999))
        .forEach(catName => {
          const arr = byCat[catName].slice().sort((a,b) => (itemIndex.get(a.id) ?? 999999) - (itemIndex.get(b.id) ?? 999999));
          board.appendChild(renderCategory(catName, arr));
        });
    }

    updateTotals();
  }

  function renderCategory(catName, items){
    const type = items[0]?.type ?? "main";
    const isTools = /Tools — 51%/.test(catName);
    const card = document.createElement("section");
    card.className = "category";

    const head = document.createElement("div"); head.className = "cat-head";
    const h2 = document.createElement("h2"); h2.textContent = catName;

    const right = document.createElement("div"); right.className = "cat-right";
    const pill = document.createElement("span"); pill.className = "pillType"; pill.textContent = (type==="main" ? "Weighted" : "Extra");
    const count = document.createElement("div"); count.className = "cat-count";
    const selectAll = document.createElement("button"); selectAll.type="button"; selectAll.className="smallbtn"; selectAll.textContent="✓ All";
    const deselectAll = document.createElement("button"); deselectAll.type="button"; deselectAll.className="smallbtn"; deselectAll.textContent="✗ None";
    const toggle = document.createElement("button"); toggle.type="button"; toggle.className="smallbtn"; toggle.textContent = "–";
    right.append(pill, count, selectAll, deselectAll, toggle);
    head.append(h2, right);

    const list = document.createElement("div"); list.className = "cat-items";

    function setAllInCategory(checkedState){
      for(const i of items){
        if(i.condensed) continue; // skip condensed control
        if(checkedState) checked.add(i.id); else checked.delete(i.id);
      }
      persist(); render();
    }
    selectAll.addEventListener("click", function(e){ e.stopPropagation(); setAllInCategory(true); });
    deselectAll.addEventListener("click", function(e){ e.stopPropagation(); setAllInCategory(false); });

    if (isTools) {
      list.appendChild(subHead("Red","red"));
      renderItems(list, items.filter(i=>i.color==="red"));
      list.appendChild(subHead("Blue","blue"));
      renderItems(list, items.filter(i=>i.color==="blue"));
      list.appendChild(subHead("Yellow","yellow"));
      renderItems(list, items.filter(i=>i.color==="yellow"));
    } else {
      renderItems(list, items);
    }

    head.addEventListener("click", e => {
      if (e.target === head || e.target === toggle) {
        if (list.classList.contains("hidden")) {
          list.classList.remove("hidden");
          toggle.textContent = "–";
        } else {
          list.classList.add("hidden");
          toggle.textContent = "+";
        }
      }
    });

    card.append(head, list);
    updateCatCount(count, items);
    return card;
  }

  /* Controls */
  expandAllBtn.addEventListener("click", () => {
    document.querySelectorAll(".cat-items").forEach(el => {
      el.classList.remove("hidden");
      const btn = el.previousElementSibling.querySelector(".smallbtn:last-child");
      if (btn) btn.textContent = "–";
    });
  });
  collapseAllBtn.addEventListener("click", () => {
    document.querySelectorAll(".cat-items").forEach(el => {
      el.classList.add("hidden");
      const btn = el.previousElementSibling.querySelector(".smallbtn:last-child");
      if (btn) btn.textContent = "+";
    });
  });

  exportBtn.addEventListener("click", () => {
    const payload = { version: 17, checked: Array.from(checked), hjCount };
    const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = "silksong-progress.json"; a.click();
    URL.revokeObjectURL(url);
  });

  importBtn.addEventListener("click", () => importFile.click());
  importFile.addEventListener("change", e => {
    const f = e.target.files[0];
    if (!f) return;
    const reader = new FileReader();
    reader.onload = function(){
      try {
        const obj = JSON.parse(reader.result);
        if (!obj || (!Array.isArray(obj.checked) && typeof obj.hjCount === "undefined")) throw new Error("bad");
        if (Array.isArray(obj.checked)) checked = new Set(obj.checked);
        if (typeof obj.hjCount !== "undefined") hjCount = Math.max(0, Math.min(HJ_TOTAL, Number(obj.hjCount)||0));
        persist();
        render();
        alert("Import complete!");
      } catch {
        alert("Import failed. Use a valid file.");
      }
      e.target.value = "";
    };
    reader.readAsText(f);
  });

  resetBtn.addEventListener("click", () => {
    if (!confirm("Reset all progress?")) return;
    checked.clear();
    hjCount = 0;
    persist();
    render();
  });

  groupBtn.addEventListener("click", function(){
    groupByAct = !groupByAct;
    this.textContent = `Group by Act: ${groupByAct ? "On" : "Off"}`;
    render();
  });

  function setFilter(next){
    filterType = next;
    [filterAllBtn, filterMainBtn, filterExtraBtn].forEach(b=>b.classList.remove("active"));
    if(next==="all")  filterAllBtn.classList.add("active");
    if(next==="main") filterMainBtn.classList.add("active");
    if(next==="extra")filterExtraBtn.classList.add("active");
    render();
  }
  filterAllBtn.addEventListener("click",  ()=>setFilter("all"));
  filterMainBtn.addEventListener("click", ()=>setFilter("main"));
  filterExtraBtn.addEventListener("click",()=>setFilter("extra"));

  searchEl.addEventListener("input", render);
  actFilterEl.addEventListener("change", render);

  function updateTotals() {
    const items = flatItems();
    const main = items.filter(i => i.type === "main");
    const extras = items.filter(i => i.type !== "main" && !i.condensed);
    const extrasCondensed = items.filter(i => i.type !== "main" && i.condensed);

    /* Weighted 100% stays based on main only */
    totalCountEl.textContent = main.length;
    let totalWeight = 0, doneWeight = 0, doneCount = 0;
    for (const it of main) {
      totalWeight += Number(it.weight) || 0;
      if (checked.has(it.id)) { doneWeight += Number(it.weight) || 0; doneCount++; }
    }
    doneCountEl.textContent = doneCount;
    const pct = totalWeight ? Math.round((doneWeight / totalWeight) * 100) : 0;
    percentEl.textContent = pct;
    barFillEl.style.width = pct + "%";

    /* Extras progress: count normal extras + condensed journal count */
    let extrasDone = 0;
    for (const it of extras) if (checked.has(it.id)) extrasDone++;
    let extrasTotal = extras.length;

    // Add condensed categories: currently only Hunter Journal
    const hasHJ = extrasCondensed.some(x => x.id === "hj_condensed");
    if (hasHJ) {
      extrasDone += hjCount;
      extrasTotal += HJ_TOTAL;
    }

    extrasDoneEl.textContent = extrasDone;
    extrasTotalEl.textContent = extrasTotal;
    const pctExtra = extrasTotal ? Math.round((extrasDone / extrasTotal) * 100) : 0;
    barFillExtrasEl.style.width = pctExtra + "%";
  }

  /* Kickoff */
  render();

})();
</script>
</body>
</html>
