<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Silksong Checklist</title>
<style>
:root{
  --fg:#eaeaea; --bg:#0e0f13; --muted:#9aa0a6; --accent:#6ee7ff; --accent2:#8fff8f;
  --card:#16171c; --edge:#22242a; --chip:#1f2128; --bar:#2a2d35;
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--fg);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
.container{max-width:1100px;margin:0 auto;padding:1rem}
.topbar{display:flex;gap:1rem;align-items:center;flex-wrap:wrap;border-bottom:1px solid var(--edge);padding-bottom:.75rem}
.topbar h1{margin:0;font-size:1.15rem;letter-spacing:.2px}
.controls{display:flex;gap:.5rem;flex-wrap:wrap;margin-left:auto}
.controls input[type="search"], .controls select{
  padding:.55rem .75rem;background:#11131a;border:1px solid #2a2d35;color:var(--fg);border-radius:.55rem
}
.controls button{
  padding:.55rem .75rem;background:#171a22;border:1px solid #2a2d35;color:var(--fg);border-radius:.55rem;cursor:pointer
}
.controls button:hover{border-color:#3a3d47}
.badge{background:var(--chip);border:1px solid var(--edge);border-radius:.5rem;padding:.25rem .5rem;color:var(--muted);font-size:.8rem}
.progress{display:grid;gap:.4rem;margin:.9rem 0}
.progress .label{color:var(--muted);font-size:.9rem}
.bar{height:10px;background:var(--bar);border-radius:999px;overflow:hidden}
.bar-fill{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2));width:0%}
.board{display:grid;gap:1rem}
.category{background:var(--card);border:1px solid var(--edge);border-radius:.8rem;overflow:hidden}
.cat-head{display:flex;align-items:center;justify-content:space-between;padding:.8rem 1rem;cursor:pointer}
.cat-head h2{margin:0;font-size:1rem}
.cat-count{color:var(--muted);font-size:.85rem}
.cat-items{padding:.2rem 1rem 1rem 1rem;display:grid;gap:.25rem}
.item{display:flex;align-items:center;gap:.6rem;padding:.4rem;border-radius:.5rem}
.item:hover{background:#1b1e26}
.item label{cursor:pointer}
.item .meta{margin-left:auto;display:flex;gap:.4rem;align-items:center}
.item .pill{font-size:.75rem;padding:.15rem .45rem;border-radius:.45rem;background:#13151c;border:1px solid #2b2e39;color:var(--muted)}
.hidden{display:none!important}
.footer{margin:1.25rem 0;color:var(--muted);text-align:center;border-top:1px solid var(--edge);padding-top:1rem}
.sep{height:1px;background:var(--edge);margin:.5rem 0}
.groupTitle{font-size:0.95rem;margin:.25rem 0 .5rem 0;color:#cfd3da}
.groupWrap{display:grid;gap:1rem}
hr.soft{border:none;border-top:1px dashed #2b2e39;margin:.5rem 0}
</style>
</head>
<body>
<div class="container">
  <div class="topbar">
    <h1>Silksong Checklist</h1>
    <span id="totalBadge" class="badge">0 items</span>
    <div class="controls">
      <input id="search" type="search" placeholder="Search items…" aria-label="Search" />
      <select id="sortBy" aria-label="Sort by">
        <option value="act">Sort: Act (asc)</option>
        <option value="name">Sort: Name (A→Z)</option>
        <option value="category">Sort: Category (A→Z)</option>
      </select>
      <select id="actFilter" aria-label="Filter by act">
        <option value="all">Act: All</option>
      </select>
      <button id="groupByAct" type="button">Group by Act: Off</button>
      <button id="expandAll" type="button">Expand All</button>
      <button id="collapseAll" type="button">Collapse All</button>
      <button id="exportBtn" type="button">Export</button>
      <input id="importFile" type="file" accept="application/json" hidden>
      <button id="importBtn" type="button">Import</button>
      <button id="resetBtn" type="button">Reset</button>
    </div>
  </div>

  <div class="progress">
    <div class="label"><span id="doneCount">0</span> / <span id="totalCount">0</span> completed</div>
    <div class="bar"><div id="barFill" class="bar-fill"></div></div>
  </div>

  <div id="board" class="board" aria-live="polite"></div>

  <div class="footer">
    <small>Progress is stored locally in your browser (localStorage). No data leaves your device.</small>
  </div>
</div>

<script>
(() => {
  const STORAGE_KEY = "silksong-checklist-v2";
  // --------- SAMPLE DATA ----------
  // You can edit/add freely. Keep ids stable.
  const DATA = {
    categories: [
      {
        name: "Main Quests",
        items: [
          { id:"mq_start",  name:"Acquire Primary Needle", act:1 },
          { id:"mq_city",   name:"Reach First Major City", act:2 },
          { id:"mq_tower",  name:"Ascend the Tower", act:3 }
        ]
      },
      {
        name: "Bosses",
        items: [
          { id:"boss_a", name:"Defeat Early Boss A", act:1 },
          { id:"boss_b", name:"Defeat City Warden", act:2 },
          { id:"boss_c", name:"Defeat Tower Guardian", act:3 }
        ]
      },
      {
        name: "Collectibles",
        items: [
          { id:"col_amber1", name:"Amber Shard (Lower)", act:1 },
          { id:"col_amber2", name:"Amber Shard (City)", act:2 },
          { id:"col_amber3", name:"Amber Shard (Spire)", act:3 }
        ]
      }
    ]
  };
  // --------- END DATA -------------

  // DOM
  const board = document.getElementById("board");
  const searchEl = document.getElementById("search");
  const sortByEl = document.getElementById("sortBy");
  const actFilterEl = document.getElementById("actFilter");
  const groupBtn = document.getElementById("groupByAct");
  const expandAllBtn = document.getElementById("expandAll");
  const collapseAllBtn = document.getElementById("collapseAll");
  const exportBtn = document.getElementById("exportBtn");
  const importBtn = document.getElementById("importBtn");
  const importFile = document.getElementById("importFile");
  const resetBtn = document.getElementById("resetBtn");
  const doneCountEl = document.getElementById("doneCount");
  const totalCountEl = document.getElementById("totalCount");
  const barFillEl = document.getElementById("barFill");
  const totalBadge = document.getElementById("totalBadge");

  // State
  let checked = new Set(JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]"));
  let groupByAct = false;

  // Build a flat list with category on each item
  function flatItems(){
    const list = [];
    DATA.categories.forEach(cat => {
      cat.items.forEach(item => list.push({...item, category:cat.name}));
    });
    return list;
  }

  // Populate Act filter
  (function initActFilter(){
    const acts = new Set(flatItems().map(i => i.act));
    [...acts].sort((a,b)=>a-b).forEach(a=>{
      const opt = document.createElement("option");
      opt.value = String(a);
      opt.textContent = `Act: ${a}`;
      actFilterEl.appendChild(opt);
    });
  })();

  // Render
  function render(){
    board.innerHTML = "";
    const items = flatItems();
    const total = items.length;
    totalCountEl.textContent = total;
    totalBadge.textContent = `${total} items`;

    // Filter by search and act
    const term = (searchEl.value || "").trim().toLowerCase();
    const actFilter = actFilterEl.value;

    let visible = items.filter(it => {
      const matchesSearch = !term || it.name.toLowerCase().includes(term) || it.category.toLowerCase().includes(term);
      const matchesAct = (actFilter === "all") || (String(it.act) === actFilter);
      return matchesSearch && matchesAct;
    });

    // Sort
    const sortBy = sortByEl.value;
    const cmp = {
      "act": (a,b)=> (a.act-b.act) || a.name.localeCompare(b.name),
      "name": (a,b)=> a.name.localeCompare(b.name),
      "category": (a,b)=> a.category.localeCompare(b.category) || a.name.localeCompare(b.name)
    }[sortBy] || ((a,b)=>0);
    visible.sort(cmp);

    // Grouping logic
    if (groupByAct){
      const byAct = new Map();
      visible.forEach(i=>{
        if(!byAct.has(i.act)) byAct.set(i.act, []);
        byAct.get(i.act).push(i);
      });
      const acts = [...byAct.keys()].sort((a,b)=>a-b);

      acts.forEach(actNum=>{
        const wrap = document.createElement("div");
        const title = document.createElement("div");
        title.className = "groupTitle";
        title.textContent = `Act ${actNum}`;
        wrap.appendChild(title);

        // Render categories within this act
        const cats = groupBy(byAct.get(actNum), "category"); // {category: [items]}
        const groupWrap = document.createElement("div");
        groupWrap.className = "groupWrap";
        Object.keys(cats).sort().forEach(catName=>{
          groupWrap.appendChild(renderCategory(catName, cats[catName]));
        });
        wrap.appendChild(groupWrap);
        board.appendChild(wrap);
        const hr = document.createElement("hr"); hr.className="soft"; board.appendChild(hr);
      });
    } else {
      // Regular category cards with whatever items remain
      const cats = groupBy(visible, "category");
      Object.keys(cats).sort().forEach(catName=>{
        board.appendChild(renderCategory(catName, cats[catName]));
      });
    }

    // Update progress
    updateCounts();
  }

  function renderCategory(catName, items){
    // Build card
    const card = document.createElement("section");
    card.className = "category";
    const head = document.createElement("div");
    head.className = "cat-head";
    const h2 = document.createElement("h2"); h2.textContent = catName;
    const count = document.createElement("div"); count.className = "cat-count";
    const toggle = document.createElement("button"); toggle.type="button"; toggle.textContent="–";
    head.appendChild(h2); head.appendChild(count); head.appendChild(toggle);

    const list = document.createElement("div");
    list.className = "cat-items";

    items.forEach(it=>{
      const row = document.createElement("div"); row.className = "item";
      const cb = document.createElement("input"); cb.type="checkbox"; cb.id = it.id; cb.checked = checked.has(it.id);
      const lab = document.createElement("label"); lab.setAttribute("for", it.id); lab.textContent = it.name;
      const meta = document.createElement("div"); meta.className="meta";
      const pillAct = document.createElement("span"); pillAct.className="pill"; pillAct.textContent = `Act ${it.act}`;
      const pillCat = document.createElement("span"); pillCat.className="pill"; pillCat.textContent = it.category;
      meta.appendChild(pillAct);
      meta.appendChild(pillCat);

      cb.addEventListener("change", ()=>{
        if(cb.checked) checked.add(it.id); else checked.delete(it.id);
        persist(); updateCounts(); updateCatCount(count, items);
      });

      row.appendChild(cb); row.appendChild(lab); row.appendChild(meta);
      list.appendChild(row);
    });

    head.addEventListener("click", (e)=>{
      if(e.target===head || e.target===toggle){
        list.classList.toggle("hidden");
        toggle.textContent = list.classList.contains("hidden") ? "+" : "–";
      }
    });

    card.appendChild(head); card.appendChild(list);
    updateCatCount(count, items);
    return card;
  }

  function updateCatCount(el, items){
    const done = items.filter(i=>checked.has(i.id)).length;
    el.textContent = `${done}/${items.length}`;
  }

  function updateCounts(){
    const all = flatItems();
    const done = all.filter(i=>checked.has(i.id)).length;
    doneCountEl.textContent = done;
    const total = all.length;
    const pct = total ? Math.round((done/total)*100) : 0;
    barFillEl.style.width = pct + "%";
  }

  function groupBy(list, key){
    return list.reduce((acc, cur)=>{
      const k = cur[key];
      if(!acc[k]) acc[k] = [];
      acc[k].push(cur);
      return acc;
    }, {});
  }

  function persist(){
    localStorage.setItem(STORAGE_KEY, JSON.stringify([...checked]));
  }

  // Events
  searchEl.addEventListener("input", render);
  sortByEl.addEventListener("change", render);
  actFilterEl.addEventListener("change", render);

  groupBtn.addEventListener("click", ()=>{
    groupByAct = !groupByAct;
    groupBtn.textContent = `Group by Act: ${groupByAct ? "On" : "Off"}`;
    render();
  });

  expandAllBtn.addEventListener("click", ()=>{
    document.querySelectorAll(".cat-items").forEach(el=>{
      el.classList.remove("hidden");
      const btn = el.previousElementSibling.querySelector("button");
      if(btn) btn.textContent = "–";
    });
  });

  collapseAllBtn.addEventListener("click", ()=>{
    document.querySelectorAll(".cat-items").forEach(el=>{
      el.classList.add("hidden");
      const btn = el.previousElementSibling.querySelector("button");
      if(btn) btn.textContent = "+";
    });
  });

  exportBtn.addEventListener("click", ()=>{
    const payload = { version:2, checked:[...checked] };
    const blob = new Blob([JSON.stringify(payload,null,2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = "silksong-checklist-progress.json"; a.click();
    URL.revokeObjectURL(url);
  });

  importBtn.addEventListener("click", ()=>importFile.click());
  importFile.addEventListener("change", async ()=>{
    const f = importFile.files?.[0]; if(!f) return;
    try{
      const txt = await f.text();
      const obj = JSON.parse(txt);
      if(!obj || !Array.isArray(obj.checked)) throw new Error("bad");
      checked = new Set(obj.checked);
      persist(); render(); alert("Import complete!");
    }catch(err){ alert("Import failed. Make sure you selected a valid export file."); }
    finally{ importFile.value = ""; }
  });

  resetBtn.addEventListener("click", ()=>{
    if(!confirm("Reset all progress?")) return;
    checked.clear(); persist(); render();
  });

  // Initial render
  render();

})();
</script>
</body>
</html>
