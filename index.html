<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Silksong 100% Checklist</title>

<!-- Fallback Trajan-like font -->
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&display=swap" rel="stylesheet" />

<style>
@font-face{
  font-family:"Trajan Pro";
  src:
    local("Trajan Pro Regular"),
    local("TrajanPro-Regular"),
    url("TrajanPro-Regular.woff2") format("woff2");
  font-weight:400;
  font-style:normal;
  font-display:swap;
}

:root{
  /* Moss grotto palette (muted greens) */
  --fg:#f5fff7;
  --muted:#d9f2de;

  --accent:#62c574;
  --accent2:#a4e3b0;

  --card:#1f3a2a;
  --cardHover:#254530;
  --edge:#2e5a40;
  --edgeStrong:#3f7c57;
  --chip:#1b3225;
  --bar:#182a20;

  --extra1:#78d18a;
  --extra2:#c4f0cc;

  --red:#ffb9b9;
  --blue:#a9cfff;
  --yellow:#ffe39a;

  /* Your files live in the repo ROOT (no assets/). Add cache-busters to beat caching. */
  --bg-image:   url("./Screenshot_SS_Moss_Grotto_01.png?v=1");
  --orn-top:    url("./375px-SS_NPC_Dialogue_Top.png?v=1");
  --orn-bottom: url("./300px-SS_NPC_Dialogue_Bottom.png?v=1");
}

/* ===== Base ===== */
*{box-sizing:border-box}
html,body{
  margin:0;
  color:var(--fg);
  font-family:"Trajan Pro","Cinzel",serif;
  letter-spacing:.2px;
  min-height:100%;
}

/* Full-page background with overlay */
body::before{
  content:"";
  position:fixed; inset:0;
  background:
    linear-gradient(rgba(10,25,18,.68), rgba(10,25,18,.68)),
    var(--bg-image) center/cover no-repeat fixed;
  z-index:-1;
}

/* Layout */
.container{max-width:1100px;margin:0 auto;padding:1rem}

/* Top bar */
.topbar{
  display:flex;gap:1rem;align-items:center;flex-wrap:wrap;
  border-bottom:2px solid var(--edge);padding-bottom:.75rem;
  backdrop-filter:saturate(120%) blur(2px);
}
.topbar h1{margin:0;font-size:1.35rem;letter-spacing:.3px}

/* Controls */
.controls{display:flex;gap:.5rem;flex-wrap:wrap;margin-left:auto;align-items:center}
.controls input[type="search"], .controls select{
  padding:.55rem .75rem;background:var(--card);border:1px solid var(--edge);color:var(--fg);border-radius:.55rem
}
.controls button{
  padding:.55rem .75rem;background:var(--card);border:1px solid var(--edge);color:var(--fg);
  border-radius:.55rem;cursor:pointer;transition:background .12s,border-color .12s,box-shadow .12s,transform .05s
}
.controls button:hover{border-color:var(--edgeStrong);background:var(--cardHover);box-shadow:0 0 0 2px rgba(98,197,116,.18)}
.controls button:active{transform:translateY(1px)}
.badge{background:var(--chip);border:1px solid var(--edge);border-radius:.5rem;padding:.25rem .5rem;color:var(--muted);font-size:.8rem}

/* Segmented filter */
.seg{display:inline-flex;border:1px solid var(--edge);border-radius:.55rem;overflow:hidden;background:var(--card)}
.seg button{background:transparent;border:none;padding:.55rem .7rem;color:var(--fg);cursor:pointer}
.seg button+button{border-left:1px solid var(--edge)}
.seg button.active{background:var(--cardHover)}

/* Progress bars */
.progress{display:grid;gap:.4rem;margin:.9rem 0}
.progress .label{color:var(--muted);font-size:.95rem}
.bar{height:10px;background:var(--bar);border-radius:999px;overflow:hidden;border:1px solid var(--edge)}
.bar-fill{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2));width:0%}

/* Cards & items */
.board{display:grid;gap:1rem}
.category{
  background:var(--card);border:1px solid var(--edge);border-radius:.9rem;overflow:hidden;
  box-shadow:0 6px 20px rgba(0,0,0,.25);
}
.cat-head{display:flex;align-items:center;justify-content:space-between;padding:.8rem 1rem;cursor:pointer}
.cat-head h2{margin:0;font-size:1.05rem}
.cat-right{display:flex;align-items:center;gap:.35rem;flex-wrap:wrap}
.pillType{font-size:.7rem;padding:.2rem .45rem;border-radius:.45rem;border:1px solid var(--edge);background:var(--cardHover);color:var(--muted)}
.cat-count{color:var(--muted);font-size:.85rem;margin-left:.25rem}

.cat-items{padding:.2rem 1rem 1rem 1rem;display:grid;gap:.25rem}
.item{display:flex;align-items:center;gap:.6rem;padding:.45rem;border-radius:.6rem;transition:background .12s}
.item:hover{background:var(--cardHover)}
.item label{cursor:pointer}

/* Pills */
.item .meta{margin-left:auto;display:flex;gap:.4rem;align-items:center}
.item .pill{
  font-size:.75rem;padding:.15rem .45rem;border-radius:.45rem;
  background:var(--cardHover);border:1px solid var(--edge);color:var(--muted)
}
.item .color{border-color:var(--edgeStrong)}
.item .color.red{color:var(--red);border-color:var(--red)!important}
.item .color.blue{color:var(--blue);border-color:var(--blue)!important}
.item .color.yellow{color:var(--yellow);border-color:var(--yellow)!important}

/* Small buttons inside cards */
.smallbtn,.locbtn{
  font-size:.75rem;padding:.25rem .5rem;border-radius:.45rem;background:var(--cardHover);border:1px solid var(--edge);
  color:var(--muted);cursor:pointer;transition:background .12s,border-color .12s,box-shadow .12s
}
.smallbtn:hover,.locbtn:hover{border-color:var(--edgeStrong);background:var(--cardHover);box-shadow:0 0 0 2px rgba(98,197,116,.18)}

/* Checkboxes */
input[type="checkbox"]{ width:18px;height:18px;accent-color:#baf2c4;cursor:pointer; }

/* Location details (closed by default) */
.loc{ display:none; grid-column:1/-1; margin:.25rem 0 0 2rem; padding:.85rem .9rem .9rem .9rem;
  border-left:3px solid var(--accent); color:#ecfff0; background:var(--cardHover); border-radius:.4rem; position:relative }
.loc.open{display:block}
.loc a{color:#eaffea;text-decoration:underline}

.orn{ width:100%;height:22px;opacity:.95;filter:drop-shadow(0 0 1px rgba(0,0,0,.15));
  background-position:center;background-repeat:no-repeat;background-size:contain;margin:.2rem 0 .6rem 0 }
.orn.top{background-image:var(--orn-top);height:24px}
.orn.bottom{background-image:var(--orn-bottom);height:20px;margin:.6rem 0 .1rem 0}

/* Footer + misc */
.hidden{display:none!important}
.footer{margin:1.25rem 0;color:var(--muted);text-align:center;border-top:2px solid var(--edge);padding-top:1rem}

/* Subhead (tools split) */
hr.soft{border:none;border-top:1px dashed var(--edge);margin:.5rem 0}
.small{font-size:.85rem;color:var(--muted)}
.subhead{margin:.5rem 1rem 0;font-size:.85rem;color:#e8ffef;display:flex;align-items:center;gap:.5rem}
.dot{width:.6rem;height:.6rem;border-radius:50%}
.dot.red{background:var(--red)} .dot.blue{background:var(--blue)} .dot.yellow{background:var(--yellow)}
</style>
</head>
<body>
<div class="container">
  <div class="topbar">
    <h1>Silksong Checklist</h1>
    <span id="totalBadge" class="badge">0 items</span>

    <div class="controls">
      <input id="search" type="search" placeholder="Search itemsâ€¦" aria-label="Search" />
      <select id="actFilter" aria-label="Filter by act">
        <option value="all">Act: All / Unknown</option>
      </select>
      <button id="groupByAct" type="button">Group by Act: Off</button>

      <div class="seg" role="group" aria-label="Filter by task type">
        <button id="filterAll"   type="button" class="active">All</button>
        <button id="filterMain"  type="button">100%</button>
        <button id="filterExtra" type="button">Extras</button>
      </div>

      <button id="expandAll" type="button">Expand All</button>
      <button id="collapseAll" type="button">Collapse All</button>
      <button id="exportBtn" type="button">Export</button>
      <input id="importFile" type="file" accept="application/json" hidden>
      <button id="importBtn" type="button">Import</button>
      <button id="resetBtn" type="button">Reset</button>
    </div>
  </div>

  <div class="progress">
    <div class="label">
      <strong><span id="percent">0</span>%</strong> of weighted 100% â€¢
      <span id="doneCount">0</span>/<span id="totalCount">0</span> items checked
    </div>
    <div class="bar"><div id="barFill" class="bar-fill"></div></div>
  </div>

  <div class="progress">
    <div class="label small">
      Extras (unweighted): <span id="extrasDone">0</span>/<span id="extrasTotal">0</span> items completed
    </div>
    <div class="bar"><div id="barFillExtras" class="bar-fill" style="background:linear-gradient(90deg,var(--extra1),var(--extra2))"></div></div>
  </div>

  <div id="board" class="board" aria-live="polite"></div>

  <div class="footer">
    <small>Progress is stored locally in your browser (localStorage). No data leaves your device.</small>
  </div>
</div>

<script>
(function(){
  var STORAGE_KEY = "silksong-checklist-v16";
  function ACT_LABEL(act){ return (act || act === 0) ? ("Act " + act) : "Act Unknown"; }

  /* ======= DATA ======= */
  var DATA = [
    { type:"main", name:"Needle Upgrades â€” 4%", items:[
      { id:"needle_sharpened", name:"Sharpened Needle", weight:1, act:1 },
      { id:"needle_shining",   name:"Shining Needle",   weight:1, act:2 },
      { id:"needle_hivesteel", name:"Hivesteel Needle", weight:1, act:2 },
      { id:"needle_pale",      name:"Pale Steel Needle",weight:1, act:3 }
    ]},

    { type:"main", name:"Mask Shards â€” 5% (order not indicative)", items:(function(){
        var arr=[], n, act;
        for(var k=0;k<20;k++){
          n = k+1;
          act = (n<=6)?1 : (n<=16)?2 : 3;
          arr.push({ id:"maskShard_"+n, name:"Mask Shard "+n, weight:0.25, act:act });
        }
        return arr;
      })()
    },

    /* Spool Fragments: 1â€“6 Act 1, 7â€“18 Act 2 (each 0.5%, total 9%) */
    { type:"main", name:"Spool Fragments â€” 9%", items:(function(){
        var arr=[], n, act;
        for(var k=0;k<18;k++){
          n = k+1; act = (n<=6)?1:2;
          arr.push({ id:"spoolFrag_"+n, name:"Spool Fragment "+n, weight:0.5, act:act });
        }
        return arr;
      })()
    },

    { type:"main", name:"Crafting Kit Upgrades â€” 4%", items:[
      { id:"kit_1", name:"Crafting Kit Expansion I",  weight:1, act:1 },
      { id:"kit_2", name:"Crafting Kit Expansion II", weight:1, act:1 },
      { id:"kit_3", name:"Crafting Kit Expansion III",weight:1, act:2 },
      { id:"kit_4", name:"Crafting Kit Expansion IV", weight:1, act:2 }
    ]},

    { type:"main", name:"Tool Pouch Upgrades â€” 4%", items:[
      { id:"pouch_1", name:"Tool Pouch Expansion I",  weight:1, act:1 },
      { id:"pouch_2", name:"Tool Pouch Expansion II", weight:1, act:1 },
      { id:"pouch_3", name:"Tool Pouch Expansion III",weight:1, act:2 },
      { id:"pouch_4", name:"Tool Pouch Expansion IV", weight:1, act:2 }
    ]},

    { type:"main", name:"Crests â€” 6%", items:[
      { id:"crest_reaper",    name:"Reaper",    weight:1, act:1 },
      { id:"crest_wanderer",  name:"Wanderer",  weight:1, act:1 },
      { id:"crest_beast",     name:"Beast",     weight:1, act:1 },
      { id:"crest_witch",     name:"Witch",     weight:1, act:2 },
      { id:"crest_architect", name:"Architect", weight:1, act:2 },
      { id:"crest_shaman",    name:"Shaman",    weight:1, act:3 }
    ]},

    { type:"main", name:"Silk Skills â€” 6%", items:[
      { id:"skill_silkspear",   name:"Silkspear",     weight:1, act:1 },
      { id:"skill_threadstorm", name:"Thread Storm",  weight:1, act:1 },
      { id:"skill_sharpdart",   name:"Sharpdart",     weight:1, act:1 },
      { id:"skill_crossstitch", name:"Cross Stitch",  weight:1, act:1 },
      { id:"skill_runerage",    name:"Rune Rage",     weight:1, act:1 },
      { id:"skill_purenails",   name:"Pure Nails",    weight:1, act:3 }
    ]},

    { type:"main", name:"Tools â€” 51% (Red / Blue / Yellow)", items:[
      /* RED */
      {id:"tool_straightpin",  name:"Straight Pin",   weight:1, act:null, color:"red"},
      {id:"tool_threefold",    name:"Threefold Pin",  weight:1, act:null, color:"red"},
      {id:"tool_stingshard",   name:"Sting Shard",    weight:1, act:null, color:"red"},
      {id:"tool_tacks",        name:"Tacks",          weight:1, act:null, color:"red"},
      {id:"tool_longpin",      name:"Longpin",        weight:1, act:null, color:"red"},
      {id:"tool_curveclaw",    name:"Curveclaw / Curvesickle", weight:1, act:null, color:"red"},
      {id:"tool_throwingring", name:"Throwing Ring",  weight:1, act:null, color:"red"},
      {id:"tool_pimpillo",     name:"Pimpillo",       weight:1, act:null, color:"red"},
      {id:"tool_conchcutter",  name:"Conchcutter",    weight:1, act:null, color:"red"},
      {id:"tool_silkshot",     name:"Silkshot",       weight:1, act:null, color:"red"},
      {id:"tool_delverdrill",  name:"Delverâ€™s Drill", weight:1, act:null, color:"red"},
      {id:"tool_cogwheel",     name:"Cogwork Wheel",  weight:1, act:null, color:"red"},
      {id:"tool_cogfly",       name:"Cogfly",         weight:1, act:null, color:"red"},
      {id:"tool_rosarycannon", name:"Rosary Cannon",  weight:1, act:null, color:"red"},
      {id:"tool_voltvessels",  name:"Voltvessels",    weight:1, act:null, color:"red"},
      {id:"tool_flintslate",   name:"Flintslate",     weight:1, act:null, color:"red"},
      {id:"tool_fleabrew",     name:"Flea Brew",      weight:1, act:null, color:"red"},
      {id:"tool_plasmium",     name:"Plasmium Phial", weight:1, act:null, color:"red"},
      /* BLUE */
      {id:"tool_druidseye",    name:"Druidâ€™s Eye / Druidâ€™s Eyes", weight:1, act:null, color:"blue"},
      {id:"tool_magmbell",     name:"Magma Bell",          weight:1, act:null, color:"blue"},
      {id:"tool_wardingbell",  name:"Warding Bell",        weight:1, act:null, color:"blue"},
      {id:"tool_pollip",       name:"Pollip Pouch",        weight:1, act:null, color:"blue"},
      {id:"tool_fracturedmask",name:"Fractured Mask",      weight:1, act:null, color:"blue"},
      {id:"tool_multibinder",  name:"Multibinder",         weight:1, act:null, color:"blue"},
      {id:"tool_weavelight",   name:"Weavelight",          weight:1, act:null, color:"blue"},
      {id:"tool_sawtooth",     name:"Sawtooth Circlet",    weight:1, act:null, color:"blue"},
      {id:"tool_injectorband", name:"Injector Band",       weight:1, act:null, color:"blue"},
      {id:"tool_spoolext",     name:"Spool Extender",      weight:1, act:null, color:"blue"},
      {id:"tool_reservebind",  name:"Reserve Bind",        weight:1, act:null, color:"blue"},
      {id:"tool_clawmirror",   name:"Claw Mirror",         weight:1, act:null, color:"blue"},
      {id:"tool_memorycrystal",name:"Memory Crystal",      weight:1, act:null, color:"blue"},
      {id:"tool_snitchpick",   name:"Snitch Pick",         weight:1, act:null, color:"blue"},
      {id:"tool_voltfilament", name:"Volt Filament",       weight:1, act:null, color:"blue"},
      {id:"tool_quicksling",   name:"Quick Sling",         weight:1, act:null, color:"blue"},
      {id:"tool_wreathpurity", name:"Wreath of Purity",    weight:1, act:null, color:"blue"},
      {id:"tool_longclaw",     name:"Longclaw",            weight:1, act:null, color:"blue"},
      {id:"tool_wispfire",     name:"Wispfire Lantern",    weight:1, act:null, color:"blue"},
      {id:"tool_eggflealia",   name:"Egg of Flealia",      weight:1, act:null, color:"blue"},
      {id:"tool_pinbadge",     name:"Pin Badge",           weight:1, act:null, color:"blue"},
      /* YELLOW */
      {id:"tool_compass",      name:"Compass",             weight:1, act:null, color:"yellow"},
      {id:"tool_shardpendant", name:"Shard Pendant",       weight:1, act:null, color:"yellow"},
      {id:"tool_magnetite_brooch", name:"Magnetite Brooch", weight:1, act:null, color:"yellow"},
      {id:"tool_weightedbelt", name:"Weighted Belt",       weight:1, act:null, color:"yellow"},
      {id:"tool_barbed",       name:"Barbed Bracelet",     weight:1, act:null, color:"yellow"},
      {id:"tool_deadbug",      name:"Dead Bugâ€™s Purse / Shell Satchel", weight:1, act:null, color:"yellow"},
      {id:"tool_magnetite_dice", name:"Magnetite Dice",    weight:1, act:null, color:"yellow"},
      {id:"tool_scuttlebrace", name:"Scuttlebrace",        weight:1, act:null, color:"yellow"},
      {id:"tool_wallcling",    name:"Ascendantâ€™s Grip",    weight:1, act:null, color:"yellow"},
      {id:"tool_spiderstrings",name:"Spider Strings",      weight:1, act:null, color:"yellow"},
      {id:"tool_silkspeed",    name:"Silkspeed Anklets",   weight:1, act:null, color:"yellow"},
      {id:"tool_thiefsmark",   name:"Thiefâ€™s Mark",        weight:1, act:null, color:"yellow"}
    ]},

    { type:"main", name:"Silk Hearts â€” 3%", items:[
      { id:"sheart_1", name:"Silk Heart I",   weight:1, act:1 },
      { id:"sheart_2", name:"Silk Heart II",  weight:1, act:2 },
      { id:"sheart_3", name:"Silk Heart III", weight:1, act:2 }
    ]},

    { type:"main", name:"Miscellaneous â€” 2%", items:[
      { id:"misc_sylphsong", name:"Sylphsong", weight:1, act:2 },
      { id:"misc_everbloom", name:"Everbloom", weight:1, act:3 }
    ]},

    /* Extras placeholders */
    { type:"extra", name:"Boss Fights", items:[ {id:"boss_placeholder1", name:"Boss â€” TBD", act:null} ]},
    { type:"extra", name:"Wishes", items:[ {id:"wish_placeholder1", name:"Wish â€” TBD", act:null} ]},
    { type:"extra", name:"The Materium", items:[ {id:"materium_placeholder1", name:"Materium Entry â€” TBD", act:null} ]},
    { type:"extra", name:"Hunter Journal", items:[ {id:"journal_placeholder1", name:"Journal Entry â€” TBD", act:null} ]},
    { type:"extra", name:"Keys", items:[ {id:"key_placeholder1", name:"Key â€” TBD", act:null} ]},
    { type:"extra", name:"Relics", items:[ {id:"relic_placeholder1", name:"Relic â€” TBD", act:null} ]},
    { type:"extra", name:"Memory Lockets", items:[ {id:"locket_placeholder1", name:"Memory Locket â€” TBD", act:null} ]},
    { type:"extra", name:"Fleas", items:[ {id:"flea_placeholder1", name:"Flea â€” TBD", act:null} ]},
    { type:"extra", name:"Pail Oil", items:[ {id:"oil_placeholder1", name:"Pail Oil â€” TBD", act:null} ]},
    { type:"extra", name:"Craft Metal", items:[ {id:"metal_placeholder1", name:"Craft Metal â€” TBD", act:null} ]}
  ];

  /* ===== Acquisition-order indices ===== */
  var categoryIndex = new Map();
  var itemIndex = new Map();
  (function buildOrder(){
    var c=0, i=0;
    for(var ci=0; ci<DATA.length; ci++){
      var cat = DATA[ci];
      if(!categoryIndex.has(cat.name)) categoryIndex.set(cat.name, c++);
      for(var ii=0; ii<cat.items.length; ii++){
        var it = cat.items[ii];
        itemIndex.set(it.id, i++);
      }
    }
  })();

  /* -------- DOM lookups -------- */
  var board = document.getElementById("board");
  var searchEl = document.getElementById("search");
  var actFilterEl = document.getElementById("actFilter");
  var doneCountEl = document.getElementById("doneCount");
  var totalCountEl = document.getElementById("totalCount");
  var percentEl = document.getElementById("percent");
  var barFillEl = document.getElementById("barFill");
  var extrasDoneEl = document.getElementById("extrasDone");
  var extrasTotalEl = document.getElementById("extrasTotal");
  var barFillExtrasEl = document.getElementById("barFillExtras");
  var totalBadge = document.getElementById("totalBadge");

  var expandAllBtn = document.getElementById("expandAll");
  var collapseAllBtn = document.getElementById("collapseAll");
  var exportBtn = document.getElementById("exportBtn");
  var importBtn = document.getElementById("importBtn");
  var importFile = document.getElementById("importFile");
  var resetBtn = document.getElementById("resetBtn");
  var groupBtn = document.getElementById("groupByAct");
  var filterAllBtn = document.getElementById("filterAll");
  var filterMainBtn = document.getElementById("filterMain");
  var filterExtraBtn = document.getElementById("filterExtra");

  /* -------- State -------- */
  var checked = new Set(JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]"));
  var groupByAct = false;
  var filterType = "all"; // "all" | "main" | "extra"

  function flatItems(){
    var list = [];
    for(var ci=0; ci<DATA.length; ci++){
      var cat = DATA[ci];
      for(var ii=0; ii<cat.items.length; ii++){
        var it = cat.items[ii];
        var obj = {};
        for(var k in it){ if(Object.prototype.hasOwnProperty.call(it,k)) obj[k]=it[k]; }
        obj.category = cat.name;
        obj.type = cat.type;
        list.push(obj);
      }
    }
    return list;
  }

  /* Populate Act filter */
  (function initActFilter(){
    var actsSet = {};
    var items = flatItems();
    for(var i=0;i<items.length;i++){
      var a = items[i].act;
      if(a || a===0){ actsSet[a]=true; }
    }
    var acts = Object.keys(actsSet).map(function(x){ return Number(x); }).sort(function(a,b){return a-b;});
    for(var j=0;j<acts.length;j++){
      var aVal = acts[j];
      var opt = document.createElement("option");
      opt.value = String(aVal);
      opt.textContent = ACT_LABEL(aVal);
      actFilterEl.appendChild(opt);
    }
  })();

  function sectionTitle(text){
    var d = document.createElement("div");
    d.textContent = text;
    d.style.margin = ".25rem 0 .5rem";
    d.style.color = "var(--muted)";
    d.style.fontSize = ".95rem";
    return d;
  }

  function subHead(txt, color){
    var sh = document.createElement("div");
    sh.className = "subhead";
    var dot = document.createElement("span"); dot.className = "dot " + color;
    var label = document.createElement("span"); label.textContent = txt;
    sh.appendChild(dot); sh.appendChild(label);
    return sh;
  }

  function renderItems(container, items){
    for(var i=0;i<items.length;i++){
      var it = items[i];
      var row = document.createElement("div"); row.className="item";
      var cb = document.createElement("input"); cb.type="checkbox"; cb.id=it.id; cb.checked = checked.has(it.id);
      var lab = document.createElement("label"); lab.setAttribute("for", it.id); lab.textContent = it.name;
      var meta = document.createElement("div"); meta.className="meta";
      if(it.weight!=null){ var w = document.createElement("span"); w.className="pill"; w.textContent = String(it.weight)+"%"; meta.appendChild(w); }
      var a = document.createElement("span"); a.className="pill"; a.textContent = ACT_LABEL(it.act); meta.appendChild(a);
      if(it.color){ var c = document.createElement("span"); c.className="pill color "+it.color; c.textContent = it.color.charAt(0).toUpperCase()+it.color.slice(1); meta.appendChild(c); }
      var locBtn = document.createElement("button"); locBtn.type="button"; locBtn.className="locbtn"; locBtn.textContent = "ðŸ“ Location";
      meta.appendChild(locBtn);

      var details = document.createElement("div"); details.className="loc";
      var ornTop = document.createElement("div"); ornTop.className="orn top";
      var ornBottom = document.createElement("div"); ornBottom.className="orn bottom";
      var body = document.createElement("div");
      body.innerHTML = (it.loc || "Location info not added yet.") + (it.url? (' â€” <a target="_blank" rel="noopener" href="'+it.url+'">Open</a>') : "");
      details.appendChild(ornTop); details.appendChild(body); details.appendChild(ornBottom);

      function toggleDetails(){ details.classList.toggle("open"); }
      lab.addEventListener("click", toggleDetails);
      locBtn.addEventListener("click", toggleDetails);

      cb.addEventListener("change", (function(id){
        return function(){
          if(this.checked) checked.add(id); else checked.delete(id);
          persist(); updateTotals();
        };
      })(it.id));

      row.appendChild(cb); row.appendChild(lab); row.appendChild(meta);
      container.appendChild(row); container.appendChild(details);
    }
  }

  function updateCatCount(el, items){
    var done=0;
    for(var i=0;i<items.length;i++){ if(checked.has(items[i].id)) done++; }
    el.textContent = done + "/" + items.length;
  }

  function updateTotals(){
    var items = flatItems();
    var main = []; var extras=[];
    for(var i=0;i<items.length;i++){
      if(items[i].type==="main") main.push(items[i]); else extras.push(items[i]);
    }

    totalCountEl.textContent = String(main.length);

    var totalWeight=0, doneWeight=0, doneCount=0;
    for(var j=0;j<main.length;j++){
      var it = main[j]; totalWeight += Number(it.weight)||0;
      if(checked.has(it.id)){ doneWeight += Number(it.weight)||0; doneCount++; }
    }
    doneCountEl.textContent = String(doneCount);
    var pct = totalWeight ? Math.round((doneWeight/totalWeight)*100) : 0;
    percentEl.textContent = String(pct);
    barFillEl.style.width = pct + "%";

    var extrasDone=0;
    for(var k=0;k<extras.length;k++){ if(checked.has(extras[k].id)) extrasDone++; }
    extrasDoneEl.textContent = String(extrasDone);
    extrasTotalEl.textContent = String(extras.length);
    var pctExtra = extras.length ? Math.round((extrasDone/extras.length)*100) : 0;
    barFillExtrasEl.style.width = pctExtra + "%";
  }

  function groupBy(list, key){
    var out = {};
    for(var i=0;i<list.length;i++){
      var k = list[i][key];
      if(!out[k]) out[k]=[];
      out[k].push(list[i]);
    }
    return out;
  }

  function render(){
    board.innerHTML = "";
    var items = flatItems();
    totalBadge.textContent = items.length + " items";

    var term = (searchEl.value || "").toLowerCase();
    var actFilter = actFilterEl.value;

    var visible = [];
    for(var i=0;i<items.length;i++){
      var it = items[i];
      var s = it.name.toLowerCase();
      var matchesSearch = (!term) || s.indexOf(term) !== -1 || it.category.toLowerCase().indexOf(term) !== -1;
      var matchesAct = (actFilter === "all") || (String(it.act) === actFilter);
      var matchesType = (filterType === "all") ? true : (filterType === "main" ? it.type==="main" : it.type!=="main");
      if(matchesSearch && matchesAct && matchesType) visible.push(it);
    }

    if(groupByAct){
      var byAct = {};
      for(var a=0;a<visible.length;a++){
        var k = (visible[a].act==null) ? "Unknown" : visible[a].act;
        if(!byAct[k]) byAct[k]=[];
        byAct[k].push(visible[a]);
      }
      var keys = Object.keys(byAct).sort(function(a,b){
        if(a==="Unknown") return 1; if(b==="Unknown") return -1; return Number(a)-Number(b);
      });

      for(var ai=0; ai<keys.length; ai++){
        var kAct = keys[ai];
        var title = (kAct==="Unknown") ? "Act Unknown" : ("Act " + kAct);
        board.appendChild(sectionTitle(title));

        var byCat = groupBy(byAct[kAct], "category");
        var catNames = Object.keys(byCat).sort(function(a,b){
          var ia = categoryIndex.has(a) ? categoryIndex.get(a) : 9999;
          var ib = categoryIndex.has(b) ? categoryIndex.get(b) : 9999;
          return ia - ib;
        });

        for(var ci=0; ci<catNames.length; ci++){
          var catName = catNames[ci];
          var itemsInCat = byCat[catName].slice().sort(function(a,b){
            var ia = itemIndex.has(a.id) ? itemIndex.get(a.id) : 999999;
            var ib = itemIndex.has(b.id) ? itemIndex.get(b.id) : 999999;
            return ia - ib;
          });
          board.appendChild(renderCategory(catName, itemsInCat));
        }

        var hr = document.createElement("hr"); hr.className="soft";
        board.appendChild(hr);
      }
    } else {
      var byCat = groupBy(visible, "category");
      var catNames2 = Object.keys(byCat).sort(function(a,b){
        var ia = categoryIndex.has(a) ? categoryIndex.get(a) : 9999;
        var ib = categoryIndex.has(b) ? categoryIndex.get(b) : 9999;
        return ia - ib;
      });
      for(var c2=0;c2<catNames2.length;c2++){
        var catName2 = catNames2[c2];
        var itemsInCat2 = byCat[catName2].slice().sort(function(a,b){
          var ia = itemIndex.has(a.id) ? itemIndex.get(a.id) : 999999;
          var ib = itemIndex.has(b.id) ? itemIndex.get(b.id) : 999999;
          return ia - ib;
        });
        board.appendChild(renderCategory(catName2, itemsInCat2));
      }
    }

    updateTotals();
  }

  function renderCategory(catName, items){
    var type = (items[0] && items[0].type) ? items[0].type : "main";
    var isTools = /Tools â€” 51%/.test(catName);
    var card = document.createElement("section");
    card.className = "category";

    var head = document.createElement("div");
    head.className = "cat-head";
    var h2 = document.createElement("h2"); h2.textContent = catName;

    var right = document.createElement("div"); right.className="cat-right";
    var pill = document.createElement("span"); pill.className="pillType"; pill.textContent = (type==="main"?"Weighted":"Extra");
    var count = document.createElement("div"); count.className = "cat-count";
    var selectAll = document.createElement("button"); selectAll.type="button"; selectAll.className="smallbtn"; selectAll.title="Select all in this category"; selectAll.textContent="âœ“ All";
    var deselectAll = document.createElement("button"); deselectAll.type="button"; deselectAll.className="smallbtn"; deselectAll.title="Deselect all in this category"; deselectAll.textContent="âœ— None";
    var toggle = document.createElement("button"); toggle.type="button"; toggle.className="smallbtn"; toggle.textContent="â€“";
    right.appendChild(pill); right.appendChild(count); right.appendChild(selectAll); right.appendChild(deselectAll); right.appendChild(toggle);
    head.appendChild(h2); head.appendChild(right);

    var list = document.createElement("div"); list.className = "cat-items";

    function setAllInCategory(checkedState){
      for(var i=0;i<items.length;i++){
        var id = items[i].id;
        if(checkedState) checked.add(id); else checked.delete(id);
      }
      persist(); render();
    }
    selectAll.addEventListener("click", function(e){ e.stopPropagation(); setAllInCategory(true); });
    deselectAll.addEventListener("click", function(e){ e.stopPropagation(); setAllInCategory(false); });

    if(isTools){
      list.appendChild(subHead("Red","red"));      renderItems(list, items.filter(function(i){return i.color==="red";}));
      list.appendChild(subHead("Blue","blue"));    renderItems(list, items.filter(function(i){return i.color==="blue";}));
      list.appendChild(subHead("Yellow","yellow"));renderItems(list, items.filter(function(i){return i.color==="yellow";}));
    } else {
      renderItems(list, items);
    }

    head.addEventListener("click", function(e){
      if(e.target===head || e.target===toggle){
        if(list.classList.contains("hidden")){
          list.classList.remove("hidden"); toggle.textContent = "â€“";
        }else{
          list.classList.add("hidden"); toggle.textContent = "+";
        }
      }
    });

    card.appendChild(head); card.appendChild(list);
    updateCatCount(count, items);
    return card;
  }

  function persist(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(Array.from(checked))); }

  /* Controls */
  document.getElementById("expandAll").addEventListener("click", function(){
    var els = document.querySelectorAll(".cat-items");
    for(var i=0;i<els.length;i++){
      els[i].classList.remove("hidden");
      var btn = els[i].previousElementSibling.querySelector(".smallbtn:last-child");
      if(btn) btn.textContent = "â€“";
    }
  });
  document.getElementById("collapseAll").addEventListener("click", function(){
    var els = document.querySelectorAll(".cat-items");
    for(var i=0;i<els.length;i++){
      els[i].classList.add("hidden");
      var btn = els[i].previousElementSibling.querySelector(".smallbtn:last-child");
      if(btn) btn.textContent = "+";
    }
  });

  document.getElementById("exportBtn").addEventListener("click", function(){
    var payload = { version:16, checked:Array.from(checked) };
    var blob = new Blob([JSON.stringify(payload,null,2)], {type:"application/json"});
    var url = URL.createObjectURL(blob);
    var a = document.createElement("a");
    a.href = url; a.download = "silksong-progress.json"; a.click();
    URL.revokeObjectURL(url);
  });

  document.getElementById("importBtn").addEventListener("click", function(){ document.getElementById("importFile").click(); });
  document.getElementById("importFile").addEventListener("change", function(e){
    var f = e.target.files && e.target.files[0]; if(!f) return;
    var reader = new FileReader();
    reader.onload = function(){
      try{
        var obj = JSON.parse(reader.result);
        if(!obj || !Array.isArray(obj.checked)) throw new Error("bad");
        checked = new Set(obj.checked);
        persist(); render(); alert("Import complete!");
      }catch(err){ alert("Import failed. Make sure you selected a valid export file."); }
      finally{ e.target.value = ""; }
    };
    reader.readAsText(f);
  });

  document.getElementById("resetBtn").addEventListener("click", function(){
    if(!confirm("Reset all progress?")) return;
    checked.clear(); persist(); render();
  });

  document.getElementById("groupByAct").addEventListener("click", function(){
    groupByAct = !groupByAct;
    this.textContent = "Group by Act: " + (groupByAct ? "On" : "Off");
    render();
  });

  function setFilter(next){
    filterType = next;
    var btns=[document.getElementById("filterAll"),document.getElementById("filterMain"),document.getElementById("filterExtra")];
    for(var i=0;i<btns.length;i++) btns[i].classList.remove("active");
    if(next==="all")  document.getElementById("filterAll").classList.add("active");
    if(next==="main") document.getElementById("filterMain").classList.add("active");
    if(next==="extra")document.getElementById("filterExtra").classList.add("active");
    render();
  }
  document.getElementById("filterAll").addEventListener("click",  function(){ setFilter("all"); });
  document.getElementById("filterMain").addEventListener("click", function(){ setFilter("main"); });
  document.getElementById("filterExtra").addEventListener("click",function(){ setFilter("extra"); });

  document.getElementById("search").addEventListener("input", render);
  document.getElementById("actFilter").addEventListener("change", render);

  /* Initial render */
  render();
})();
</script>
</body>
</html>
