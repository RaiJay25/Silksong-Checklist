<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Silksong 100% Checklist</title>

  <!-- Trajan-like fallback font -->
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&display=swap" rel="stylesheet" />

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="./Weaver.png?v=1" />

  <style>
  @font-face{
    font-family:"Trajan Pro";
    src:
      local("Trajan Pro Regular"),
      local("TrajanPro-Regular"),
      url("TrajanPro-Regular.woff2") format("woff2");
    font-weight:400;
    font-style:normal;
    font-display:swap;
  }

  :root{
    /* Moss grotto palette */
    --fg:#f5fff7;
    --muted:#d9f2de;
    --accent:#62c574;
    --accent2:#a4e3b0;
    --card:#1f3a2a;
    --cardHover:#254530;
    --edge:#2e5a40;
    --edgeStrong:#3f7c57;
    --chip:#1b3225;
    --bar:#182a20;
    --extra1:#78d18a;
    --extra2:#c4f0cc;
    --red:#ffb9b9;
    --blue:#a9cfff;
    --yellow:#ffe39a;

    /* Images (files are in repo ROOT) */
    --bg-image:   url("./Screenshot_SS_Moss_Grotto_01.png?v=1");
    --orn-top:    url("./375px-SS_NPC_Dialogue_Top.png?v=1");
    --orn-bottom: url("./300px-SS_NPC_Dialogue_Bottom.png?v=1");
  }

  *{box-sizing:border-box}
  html,body{
    margin:0;
    color:var(--fg);
    font-family:"Trajan Pro","Cinzel",serif;
    letter-spacing:.2px;
    min-height:100%;
  }

  /* Background with dark green overlay */
  body::before{
    content:"";
    position:fixed; inset:0;
    background:
      linear-gradient(rgba(10,25,18,.68), rgba(10,25,18,.68)),
      var(--bg-image) center/cover no-repeat fixed;
    z-index:-1;
  }

  .container{max-width:1100px;margin:0 auto;padding:1rem}

  .topbar{
    display:flex;gap:1rem;align-items:center;flex-wrap:wrap;
    border-bottom:2px solid var(--edge);padding-bottom:.75rem;
    backdrop-filter:saturate(120%) blur(2px);
  }
  .topbar h1{margin:0;font-size:1.35rem;letter-spacing:.3px}

  .controls{display:flex;gap:.5rem;flex-wrap:wrap;margin-left:auto;align-items:center}
  .controls input[type="search"], .controls select{
    padding:.55rem .75rem;background:var(--card);border:1px solid var(--edge);color:var(--fg);border-radius:.55rem
  }
  .controls button{
    padding:.55rem .75rem;background:var(--card);border:1px solid var(--edge);color:var(--fg);
    border-radius:.55rem;cursor:pointer;transition:background .12s,border-color .12s,box-shadow .12s,transform .05s
  }
  .controls button:hover{border-color:var(--edgeStrong);background:var(--cardHover);box-shadow:0 0 0 2px rgba(98,197,116,.18)}
  .controls button:active{transform:translateY(1px)}
  .badge{background:var(--chip);border:1px solid var(--edge);border-radius:.5rem;padding:.25rem .5rem;color:var(--muted);font-size:.8rem}

  /* Segmented filter */
  .seg{display:inline-flex;border:1px solid var(--edge);border-radius:.55rem;overflow:hidden;background:var(--card)}
  .seg button{background:transparent;border:none;padding:.55rem .7rem;color:var(--fg);cursor:pointer}
  .seg button+button{border-left:1px solid var(--edge)}
  .seg button.active{background:var(--cardHover)}

  /* Progress */
  .progress{display:grid;gap:.4rem;margin:.9rem 0}
  .progress .label{color:var(--muted);font-size:.95rem}
  .bar{height:10px;background:var(--bar);border-radius:999px;overflow:hidden;border:1px solid var(--edge)}
  .bar-fill{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2));width:0%}

  /* Cards & items */
  .board{display:grid;gap:1rem}
  .category{
    background:var(--card);border:1px solid var(--edge);border-radius:.9rem;overflow:hidden;
    box-shadow:0 6px 20px rgba(0,0,0,.25);
  }
  .cat-head{display:flex;align-items:center;justify-content:space-between;padding:.8rem 1rem;cursor:pointer}
  .cat-head h2{margin:0;font-size:1.05rem}
  .cat-right{display:flex;align-items:center;gap:.35rem;flex-wrap:wrap}
  .pillType{font-size:.7rem;padding:.2rem .45rem;border-radius:.45rem;border:1px solid var(--edge);background:var(--cardHover);color:var(--muted)}
  .cat-count{color:var(--muted);font-size:.85rem;margin-left:.25rem}

  .cat-items{padding:.2rem 1rem 1rem 1rem;display:grid;gap:.25rem}
  .item{display:flex;align-items:center;gap:.6rem;padding:.45rem;border-radius:.6rem;transition:background .12s}
  .item:hover{background:var(--cardHover)}
  .item label{cursor:pointer}

  .item .meta{margin-left:auto;display:flex;gap:.4rem;align-items:center}
  .item .pill{
    font-size:.75rem;padding:.15rem .45rem;border-radius:.45rem;
    background:var(--cardHover);border:1px solid var(--edge);color:var(--muted)
  }
  .item .color.red{color:var(--red);border-color:var(--red)!important}
  .item .color.blue{color:var(--blue);border-color:var(--blue)!important}
  .item .color.yellow{color:var(--yellow);border-color:var(--yellow)!important}

  .smallbtn,.locbtn{
    font-size:.75rem;padding:.25rem .5rem;border-radius:.45rem;background:var(--cardHover);border:1px solid var(--edge);
    color:var(--muted);cursor:pointer;transition:background .12s,border-color .12s,box-shadow .12s
  }
  .smallbtn:hover,.locbtn:hover{border-color:var(--edgeStrong);background:var(--cardHover);box-shadow:0 0 0 2px rgba(98,197,116,.18)}

  input[type="checkbox"]{ width:18px;height:18px;accent-color:#baf2c4;cursor:pointer; }

  /* Location details (closed by default) */
  .loc{ display:none; grid-column:1/-1; margin:.25rem 0 0 2rem; padding:.85rem .9rem .9rem .9rem;
    border-left:3px solid var(--accent); color:#ecfff0; background:var(--cardHover); border-radius:.4rem; position:relative }
  .loc.open{display:block}
  .loc a{color:#eaffea;text-decoration:underline}

  /* Option A ornaments (no stretch) */
  .orn{
    width:100%;
    height:22px;
    opacity:.95;
    filter:drop-shadow(0 0 1px rgba(0,0,0,.15));
    background-position:center;
    background-repeat:no-repeat;
    background-size:contain;
    margin:.2rem 0 .6rem 0;
  }
  .orn.top{background-image:var(--orn-top);height:24px}
  .orn.bottom{background-image:var(--orn-bottom);height:20px;margin:.6rem 0 .1rem 0}

  .hidden{display:none!important}
  .footer{margin:1.25rem 0;color:var(--muted);text-align:center;border-top:2px solid var(--edge);padding-top:1rem}
  hr.soft{border:none;border-top:1px dashed var(--edge);margin:.5rem 0}
  .small{font-size:.85rem;color:var(--muted)}
  .subhead{margin:.5rem 1rem 0;font-size:.85rem;color:#e8ffef;display:flex;align-items:center;gap:.5rem}
  .dot{width:.6rem;height:.6rem;border-radius:50%}
  .dot.red{background:var(--red)} .dot.blue{background:var(--blue)} .dot.yellow{background:var(--yellow)}
  </style>
</head>
<body>
  <div class="container">
    <div class="topbar">
      <h1>Silksong Checklist</h1>
      <span id="totalBadge" class="badge">0 items</span>

      <div class="controls">
        <input id="search" type="search" placeholder="Search items…" aria-label="Search" />
        <select id="actFilter" aria-label="Filter by act">
          <option value="all">Act: All / Unknown</option>
        </select>
        <button id="groupByAct" type="button">Group by Act: Off</button>

        <div class="seg" role="group" aria-label="Filter by task type">
          <button id="filterAll"   type="button" class="active">All</button>
          <button id="filterMain"  type="button">100%</button>
          <button id="filterExtra" type="button">Extras</button>
        </div>

        <button id="expandAll" type="button">Expand All</button>
        <button id="collapseAll" type="button">Collapse All</button>
        <button id="exportBtn" type="button">Export</button>
        <input id="importFile" type="file" accept="application/json" hidden>
        <button id="importBtn" type="button">Import</button>
        <button id="resetBtn" type="button">Reset</button>
      </div>
    </div>

    <!-- Weighted -->
    <div class="progress">
      <div class="label">
        <strong><span id="percent">0</span>%</strong> of weighted 100% •
        <span id="doneCount">0</span>/<span id="totalCount">0</span> items checked
      </div>
      <div class="bar"><div id="barFill" class="bar-fill"></div></div>
    </div>

    <!-- Extras -->
    <div class="progress">
      <div class="label small">
        Extras (unweighted): <span id="extrasDone">0</span>/<span id="extrasTotal">0</span> items completed
      </div>
      <div class="bar"><div id="barFillExtras" class="bar-fill" style="background:linear-gradient(90deg,var(--extra1),var(--extra2))"></div></div>
    </div>

    <div id="board" class="board" aria-live="polite"></div>

    <div class="footer">
      <small>Progress is stored locally in your browser (localStorage). No data leaves your device.</small>
    </div>
  </div>

<script>
/* ------ JavaScript (Tools acts updated only) ------ */
(function() {
  const STORAGE_KEY = "silksong-checklist-v16";
  function ACT_LABEL(a) { return (a || a === 0) ? `Act ${a}` : "Act Unknown"; }

  const DATA = [
    { type:"main", name:"Needle Upgrades — 4%", items:[
      {id:"needle_sharpened", name:"Sharpened Needle", weight:1, act:1},
      {id:"needle_shining", name:"Shining Needle", weight:1, act:2},
      {id:"needle_hivesteel", name:"Hivesteel Needle", weight:1, act:2},
      {id:"needle_pale", name:"Pale Steel Needle", weight:1, act:3},
    ]},
    { type:"main", name:"Mask Shards — 5%", items:(function(){
        const arr = [];
        for (let k = 0; k < 20; k++) {
          const n = k+1;
          const act = (n <=6) ? 1 : (n <=16 ? 2 : 3);
          arr.push({ id:`maskShard_${n}`, name:`Mask Shard ${n}`, weight:0.25, act });
        }
        return arr;
    })() },
    { type:"main", name:"Spool Fragments — 9%", items:(function(){
        const arr = [];
        for (let k = 0; k < 18; k++) {
          const n = k+1;
          const act = (n <=6) ? 1 : 2;  // first 6 => Act1, rest => Act2
          arr.push({ id:`spoolFrag_${n}`, name:`Spool Fragment ${n}`, weight:0.5, act });
        }
        return arr;
    })() },
    { type:"main", name:"Crafting Kit Upgrades — 4%", items:[
      {id:"kit_1", name:"Crafting Kit Expansion I", weight:1, act:1},
      {id:"kit_2", name:"Crafting Kit Expansion II", weight:1, act:1},
      {id:"kit_3", name:"Crafting Kit Expansion III", weight:1, act:2},
      {id:"kit_4", name:"Crafting Kit Expansion IV", weight:1, act:2},
    ]},
    { type:"main", name:"Tool Pouch Upgrades — 4%", items:[
      {id:"pouch_1", name:"Tool Pouch Expansion I", weight:1, act:1},
      {id:"pouch_2", name:"Tool Pouch Expansion II", weight:1, act:1},
      {id:"pouch_3", name:"Tool Pouch Expansion III", weight:1, act:2},
      {id:"pouch_4", name:"Tool Pouch Expansion IV", weight:1, act:2},
    ]},
    { type:"main", name:"Crests — 6%", items:[
      {id:"crest_reaper", name:"Reaper", weight:1, act:1},
      {id:"crest_wanderer", name:"Wanderer", weight:1, act:1},
      {id:"crest_beast", name:"Beast", weight:1, act:1},
      {id:"crest_witch", name:"Witch", weight:1, act:2},
      {id:"crest_architect", name:"Architect", weight:1, act:2},
      {id:"crest_shaman", name:"Shaman", weight:1, act:3},
    ]},
    { type:"main", name:"Silk Skills — 6%", items:[
      {id:"skill_silkspear", name:"Silkspear", weight:1, act:1},
      {id:"skill_threadstorm", name:"Thread Storm", weight:1, act:1},
      {id:"skill_sharpdart", name:"Sharpdart", weight:1, act:1},
      {id:"skill_crossstitch", name:"Cross Stitch", weight:1, act:1},
      {id:"skill_runerage", name:"Rune Rage", weight:1, act:1},
      {id:"skill_purenails", name:"Pure Nails", weight:1, act:3},
    ]},

    /* ============== TOOLS — 51% (Acts updated) ============== */
    { type:"main", name:"Tools — 51%", items:[
      /* RED — Act 1 */
      {id:"tool_straightpin",  name:"Straight Pin",   weight:1, act:1, color:"red"},
      {id:"tool_threefold",    name:"Threefold Pin",  weight:1, act:1, color:"red"},
      {id:"tool_longpin",      name:"Longpin",        weight:1, act:1, color:"red"},
      {id:"tool_curveclaw",    name:"Curveclaw / Curvesickle", weight:1, act:1, color:"red", loc:"Upgraded in Act 3"},
      {id:"tool_tacks",        name:"Tacks",          weight:1, act:1, color:"red"},
      {id:"tool_stingshard",   name:"Sting Shard",    weight:1, act:1, color:"red"},
      {id:"tool_pimpillo",     name:"Pimpillo",       weight:1, act:1, color:"red"},
      {id:"tool_flintslate",   name:"Flintslate",     weight:1, act:1, color:"red"},
      {id:"tool_plasmium",     name:"Plasmium Phial", weight:1, act:1, color:"red"},
      {id:"tool_fleabrew",     name:"Flea Brew",      weight:1, act:1, color:"red"},

      /* RED — Act 2 */
      {id:"tool_silkshot",     name:"Silkshot",       weight:1, act:2, color:"red"},
      {id:"tool_throwingring", name:"Throwing Ring",  weight:1, act:2, color:"red"},
      {id:"tool_conchcutter",  name:"Conchcutter",    weight:1, act:2, color:"red"},
      {id:"tool_delverdrill",  name:"Delver’s Drill", weight:1, act:2, color:"red"},
      {id:"tool_cogwheel",     name:"Cogwork Wheel",  weight:1, act:2, color:"red"},
      {id:"tool_voltvessels",  name:"Voltvessels",    weight:1, act:2, color:"red"},
      {id:"tool_cogfly",       name:"Cogfly",         weight:1, act:2, color:"red"},
      {id:"tool_rosarycannon", name:"Rosary Cannon",  weight:1, act:2, color:"red"},

      /* BLUE — Act 1 */
      {id:"tool_druidseye",    name:"Druid’s Eye / Druid’s Eyes", weight:1, act:1, color:"blue"},
      {id:"tool_magmbell",     name:"Magma Bell",          weight:1, act:1, color:"blue"},
      {id:"tool_wardingbell",  name:"Warding Bell",        weight:1, act:1, color:"blue"},
      {id:"tool_pollip",       name:"Pollip Pouch",        weight:1, act:1, color:"blue"},
      {id:"tool_fracturedmask",name:"Fractured Mask",      weight:1, act:1, color:"blue"},
      {id:"tool_multibinder",  name:"Multibinder",         weight:1, act:1, color:"blue"},
      {id:"tool_weavelight",   name:"Weavelight",          weight:1, act:1, color:"blue"},

      /* BLUE — Act 2 */
      {id:"tool_sawtooth",     name:"Sawtooth Circlet",    weight:1, act:2, color:"blue"},
      {id:"tool_injectorband", name:"Injector Band",       weight:1, act:2, color:"blue"},
      {id:"tool_spoolext",     name:"Spool Extender",      weight:1, act:2, color:"blue"},
      {id:"tool_reservebind",  name:"Reserve Bind",        weight:1, act:2, color:"blue"},
      {id:"tool_clawmirror",   name:"Claw Mirror",         weight:1, act:2, color:"blue"},
      {id:"tool_memorycrystal",name:"Memory Crystal",      weight:1, act:2, color:"blue"},
      {id:"tool_snitchpick",   name:"Snitch Pick",         weight:1, act:2, color:"blue"},
      {id:"tool_voltfilament", name:"Volt Filament",       weight:1, act:2, color:"blue"},
      {id:"tool_quicksling",   name:"Quick Sling",         weight:1, act:2, color:"blue"},
      {id:"tool_wreathpurity", name:"Wreath of Purity",    weight:1, act:2, color:"blue"},
      {id:"tool_longclaw",     name:"Longclaw",            weight:1, act:2, color:"blue"},
      {id:"tool_wispfire",     name:"Wispfire Lantern",    weight:1, act:2, color:"blue"},
      {id:"tool_eggflealia",   name:"Egg of Flealia",      weight:1, act:2, color:"blue"},

      /* BLUE — Act 3 */
      {id:"tool_pinbadge",     name:"Pin Badge",           weight:1, act:3, color:"blue"},

      /* YELLOW — Act 1 */
      {id:"tool_compass",      name:"Compass",             weight:1, act:1, color:"yellow"},
      {id:"tool_shardpendant", name:"Shard Pendant",       weight:1, act:1, color:"yellow"},
      {id:"tool_magnetite_brooch", name:"Magnetite Brooch", weight:1, act:1, color:"yellow"},
      {id:"tool_weightedbelt", name:"Weighted Belt",       weight:1, act:1, color:"yellow"},
      {id:"tool_barbed",       name:"Barbed Bracelet",     weight:1, act:1, color:"yellow"},
      {id:"tool_deadbug",      name:"Dead Bug’s Purse / Shell Satchel", weight:1, act:1, color:"yellow"},
      {id:"tool_silkspeed",    name:"Silkspeed Anklets",   weight:1, act:1, color:"yellow"},
      {id:"tool_thiefsmark",   name:"Thief’s Mark",        weight:1, act:1, color:"yellow"},

      /* YELLOW — Act 2 */
      {id:"tool_magnetite_dice", name:"Magnetite Dice",    weight:1, act:2, color:"yellow"},
      {id:"tool_scuttlebrace", name:"Scuttlebrace",        weight:1, act:2, color:"yellow"},
      {id:"tool_wallcling",    name:"Ascendant’s Grip",    weight:1, act:2, color:"yellow"},
      {id:"tool_spiderstrings",name:"Spider Strings",      weight:1, act:2, color:"yellow"}
    ]},

    { type:"main", name:"Silk Hearts — 3%", items:[
      {id:"sheart_1", name:"Silk Heart I", weight:1, act:1},
      {id:"sheart_2", name:"Silk Heart II", weight:1, act:2},
      {id:"sheart_3", name:"Silk Heart III", weight:1, act:2},
    ]},
    { type:"main", name:"Miscellaneous — 2%", items:[
      {id:"misc_sylphsong", name:"Sylphsong", weight:1, act:2},
      {id:"misc_everbloom", name:"Everbloom", weight:1, act:3},
    ]},

    /* Extras placeholders */
    { type:"extra", name:"Boss Fights", items:[ {id:"boss_placeholder1", name:"Boss — TBD", act:null} ]},
    { type:"extra", name:"Wishes", items:[ {id:"wish_placeholder1", name:"Wish — TBD", act:null} ]},
    { type:"extra", name:"The Materium", items:[ {id:"materium_placeholder1", name:"Materium Entry — TBD", act:null} ]},
    { type:"extra", name:"Hunter Journal", items:[ {id:"journal_placeholder1", name:"Journal Entry — TBD", act:null} ]},
    { type:"extra", name:"Keys", items:[ {id:"key_placeholder1", name:"Key — TBD", act:null} ]},
    { type:"extra", name:"Relics", items:[ {id:"relic_placeholder1", name:"Relic — TBD", act:null} ]},
    { type:"extra", name:"Memory Lockets", items:[ {id:"locket_placeholder1", name:"Memory Locket — TBD", act:null} ]},
    { type:"extra", name:"Fleas", items:[ {id:"flea_placeholder1", name:"Flea — TBD", act:null} ]},
    { type:"extra", name:"Pail Oil", items:[ {id:"oil_placeholder1", name:"Pail Oil — TBD", act:null} ]},
    { type:"extra", name:"Craft Metal", items:[ {id:"metal_placeholder1", name:"Craft Metal — TBD", act:null} ]}
  ];

  const categoryIndex = new Map();
  const itemIndex = new Map();
  (function buildOrder() {
    let c = 0, i = 0;
    for (const cat of DATA) {
      if (!categoryIndex.has(cat.name)) categoryIndex.set(cat.name, c++);
      for (const it of cat.items) {
        itemIndex.set(it.id, i++);
      }
    }
  })();

  const board = document.getElementById("board");
  const searchEl = document.getElementById("search");
  const actFilterEl = document.getElementById("actFilter");
  const doneCountEl = document.getElementById("doneCount");
  const totalCountEl = document.getElementById("totalCount");
  const percentEl = document.getElementById("percent");
  const barFillEl = document.getElementById("barFill");
  const extrasDoneEl = document.getElementById("extrasDone");
  const extrasTotalEl = document.getElementById("extrasTotal");
  const barFillExtrasEl = document.getElementById("barFillExtras");
  const totalBadge = document.getElementById("totalBadge");

  const expandAllBtn = document.getElementById("expandAll");
  const collapseAllBtn = document.getElementById("collapseAll");
  const exportBtn = document.getElementById("exportBtn");
  const importBtn = document.getElementById("importBtn");
  const importFile = document.getElementById("importFile");
  const resetBtn = document.getElementById("resetBtn");
  const groupBtn = document.getElementById("groupByAct");
  const filterAllBtn = document.getElementById("filterAll");
  const filterMainBtn = document.getElementById("filterMain");
  const filterExtraBtn = document.getElementById("filterExtra");

  let checked = new Set(JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]"));
  let groupByAct = false;
  let filterType = "all";

  function flatItems(){
    const list = [];
    for (const cat of DATA) {
      for (const it of cat.items) {
        list.push({...it, category: cat.name, type: cat.type});
      }
    }
    return list;
  }

  (function initActFilter(){
    const acts = new Set(flatItems().map(i => i.act).filter(a => a !== null && a !== undefined));
    Array.from(acts).sort((a,b)=>a-b).forEach(a => {
      const opt = document.createElement("option");
      opt.value = String(a);
      opt.textContent = ACT_LABEL(a);
      actFilterEl.appendChild(opt);
    });
  })();

  function sectionTitle(text){
    const d = document.createElement("div");
    d.textContent = text;
    d.style.margin = ".25rem 0 .5rem";
    d.style.color = "var(--muted)";
    d.style.fontSize = ".95rem";
    return d;
  }

  function subHead(txt, color){
    const sh = document.createElement("div");
    sh.className = "subhead";
    const dot = document.createElement("span"); dot.className = "dot " + color;
    const label = document.createElement("span"); label.textContent = txt;
    sh.append(dot, label);
    return sh;
  }

  function renderItems(container, items) {
    for (const it of items) {
      const row = document.createElement("div"); row.className = "item";
      const cb = document.createElement("input");
      cb.type = "checkbox"; cb.id = it.id; cb.checked = checked.has(it.id);
      const lab = document.createElement("label"); lab.setAttribute("for", it.id); lab.textContent = it.name;
      const meta = document.createElement("div"); meta.className = "meta";
      if (it.weight != null) {
        const w = document.createElement("span"); w.className = "pill"; w.textContent = `${it.weight}%`;
        meta.appendChild(w);
      }
      const a = document.createElement("span"); a.className = "pill"; a.textContent = ACT_LABEL(it.act);
      meta.appendChild(a);
      if (it.color) {
        const c = document.createElement("span"); c.className = `pill color ${it.color}`; c.textContent = it.color.charAt(0).toUpperCase() + it.color.slice(1);
        meta.appendChild(c);
      }
      const locBtn = document.createElement("button"); locBtn.type = "button"; locBtn.className = "locbtn"; locBtn.textContent = "📍 Location";
      meta.appendChild(locBtn);

      const details = document.createElement("div"); details.className = "loc";
      const ornTop = document.createElement("div"); ornTop.className = "orn top";
      const ornBottom = document.createElement("div"); ornBottom.className = "orn bottom";
      const body = document.createElement("div");
      body.innerHTML = (it.loc || "Location info not added yet.") + (it.url ? ` — <a target="_blank" rel="noopener" href="${it.url}">Open</a>` : "");
      details.append(ornTop, body, ornBottom);

      function toggleDetails() {
        details.classList.toggle("open");
      }
      lab.addEventListener("click", toggleDetails);
      locBtn.addEventListener("click", toggleDetails);

      cb.addEventListener("change", () => {
        if (cb.checked) checked.add(it.id);
        else checked.delete(it.id);
        persist();
        updateTotals();
      });

      row.append(cb, lab, meta);
      container.append(row, details);
    }
  }

  function updateCatCount(el, items){
    const done = items.filter(i => checked.has(i.id)).length;
    el.textContent = `${done}/${items.length}`;
  }

  function groupBy(list, key) {
    const out = {};
    for (const it of list) {
      const k = it[key];
      if (!out[k]) out[k] = [];
      out[k].push(it);
    }
    return out;
  }

  function render(){
    board.innerHTML = "";
    const items = flatItems();
    totalBadge.textContent = `${items.length} items`;

    const term = (searchEl.value || "").trim().toLowerCase();
    const actFilter = actFilterEl.value;

    const visible = items.filter(it => {
      const s = it.name.toLowerCase();
      const matchesSearch = !term || s.includes(term) || it.category.toLowerCase().includes(term);
      const matchesAct = actFilter === "all" || String(it.act) === actFilter;
      let matchesType = true;
      if (filterType === "main") matchesType = it.type === "main";
      else if (filterType === "extra") matchesType = it.type !== "main";
      return matchesSearch && matchesAct && matchesType;
    });

    if (groupByAct) {
      const byAct = {};
      for (const it of visible) {
        const k = it.act == null ? "Unknown" : it.act;
        (byAct[k] ||= []).push(it);
      }
      const keys = Object.keys(byAct).sort((a,b) => {
        if (a === "Unknown") return 1;
        if (b === "Unknown") return -1;
        return Number(a) - Number(b);
      });
      for (const k of keys) {
        const title = k === "Unknown" ? "Act Unknown" : `Act ${k}`;
        board.appendChild(sectionTitle(title));

        const byCat = groupBy(byAct[k], "category");
        Object.keys(byCat)
          .sort((a,b) => (categoryIndex.get(a) ?? 9999) - (categoryIndex.get(b) ?? 9999))
          .forEach(catName => {
            const arr = byCat[catName].slice().sort((a,b) => (itemIndex.get(a.id) ?? 999999) - (itemIndex.get(b.id) ?? 999999));
            board.appendChild(renderCategory(catName, arr));
          });

        const hr = document.createElement("hr"); hr.className="soft";
        board.appendChild(hr);
      }
    } else {
      const byCat = groupBy(visible, "category");
      Object.keys(byCat)
        .sort((a,b) => (categoryIndex.get(a) ?? 9999) - (categoryIndex.get(b) ?? 9999))
        .forEach(catName => {
          const arr = byCat[catName].slice().sort((a,b) => (itemIndex.get(a.id) ?? 999999) - (itemIndex.get(b.id) ?? 999999));
          board.appendChild(renderCategory(catName, arr));
        });
    }

    updateTotals();
  }

  function renderCategory(catName, items){
    const type = items[0]?.type ?? "main";
    const isTools = /Tools — 51%/.test(catName);
    const card = document.createElement("section");
    card.className = "category";

    const head = document.createElement("div"); head.className = "cat-head";
    const h2 = document.createElement("h2"); h2.textContent = catName;

    const right = document.createElement("div"); right.className = "cat-right";
    const pill = document.createElement("span"); pill.className = "pillType"; pill.textContent = (type==="main" ? "Weighted" : "Extra");
    const count = document.createElement("div"); count.className = "cat-count";
    const selectAll = document.createElement("button"); selectAll.type="button"; selectAll.className="smallbtn"; selectAll.textContent="✓ All";
    const deselectAll = document.createElement("button"); deselectAll.type="button"; deselectAll.className="smallbtn"; deselectAll.textContent="✗ None";
    const toggle = document.createElement("button"); toggle.type="button"; toggle.className="smallbtn"; toggle.textContent="–";
    right.append(pill, count, selectAll, deselectAll, toggle);
    head.append(h2, right);

    const list = document.createElement("div"); list.className = "cat-items";

    function setAllInCategory(checkedState){
      for(const i of items){
        if(checkedState) checked.add(i.id); else checked.delete(i.id);
      }
      persist(); render();
    }
    selectAll.addEventListener("click", function(e){ e.stopPropagation(); setAllInCategory(true); });
    deselectAll.addEventListener("click", function(e){ e.stopPropagation(); setAllInCategory(false); });

    if (isTools) {
      list.appendChild(subHead("Red","red"));
      renderItems(list, items.filter(i=>i.color==="red"));
      list.appendChild(subHead("Blue","blue"));
      renderItems(list, items.filter(i=>i.color==="blue"));
      list.appendChild(subHead("Yellow","yellow"));
      renderItems(list, items.filter(i=>i.color==="yellow"));
    } else {
      renderItems(list, items);
    }

    head.addEventListener("click", e => {
      if (e.target === head || e.target === toggle) {
        if (list.classList.contains("hidden")) {
          list.classList.remove("hidden");
          toggle.textContent = "–";
        } else {
          list.classList.add("hidden");
          toggle.textContent = "+";
        }
      }
    });

    card.append(head, list);
    updateCatCount(count, items);
    return card;
  }

  function persist() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(Array.from(checked)));
  }

  /* Controls */
  document.getElementById("expandAll").addEventListener("click", () => {
    document.querySelectorAll(".cat-items").forEach(el => {
      el.classList.remove("hidden");
      const btn = el.previousElementSibling.querySelector(".smallbtn:last-child");
      if (btn) btn.textContent = "–";
    });
  });
  document.getElementById("collapseAll").addEventListener("click", () => {
    document.querySelectorAll(".cat-items").forEach(el => {
      el.classList.add("hidden");
      const btn = el.previousElementSibling.querySelector(".smallbtn:last-child");
      if (btn) btn.textContent = "+";
    });
  });

  document.getElementById("exportBtn").addEventListener("click", () => {
    const payload = { version: 16, checked: Array.from(checked) };
    const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = "silksong-progress.json"; a.click();
    URL.revokeObjectURL(url);
  });

  document.getElementById("importBtn").addEventListener("click", () => importFile.click());
  document.getElementById("importFile").addEventListener("change", e => {
    const f = e.target.files[0];
    if (!f) return;
    const reader = new FileReader();
    reader.onload = function(){
      try {
        const obj = JSON.parse(reader.result);
        if (!obj || !Array.isArray(obj.checked)) throw new Error("bad");
        checked = new Set(obj.checked);
        persist();
        render();
        alert("Import complete!");
      } catch {
        alert("Import failed. Use a valid file.");
      }
      e.target.value = "";
    };
    reader.readAsText(f);
  });

  document.getElementById("resetBtn").addEventListener("click", () => {
    if (!confirm("Reset all progress?")) return;
    checked.clear();
    persist();
    render();
  });

  document.getElementById("groupByAct").addEventListener("click", function(){
    groupByAct = !groupByAct;
    this.textContent = `Group by Act: ${groupByAct ? "On" : "Off"}`;
    render();
  });

  function setFilter(next){
    filterType = next;
    const btns=[document.getElementById("filterAll"),document.getElementById("filterMain"),document.getElementById("filterExtra")];
    btns.forEach(b=>b.classList.remove("active"));
    if(next==="all")  document.getElementById("filterAll").classList.add("active");
    if(next==="main") document.getElementById("filterMain").classList.add("active");
    if(next==="extra")document.getElementById("filterExtra").classList.add("active");
    render();
  }
  document.getElementById("filterAll").addEventListener("click",  ()=>setFilter("all"));
  document.getElementById("filterMain").addEventListener("click", ()=>setFilter("main"));
  document.getElementById("filterExtra").addEventListener("click",()=>setFilter("extra"));

  document.getElementById("search").addEventListener("input", render);
  document.getElementById("actFilter").addEventListener("change", render);

  function updateTotals() {
    const items = flatItems();
    const main = items.filter(i => i.type === "main");
    const extras = items.filter(i => i.type !== "main");

    totalCountEl.textContent = main.length;
    let totalWeight = 0, doneWeight = 0, doneCount = 0;
    for (const it of main) {
      totalWeight += Number(it.weight) || 0;
      if (checked.has(it.id)) { doneWeight += Number(it.weight) || 0; doneCount++; }
    }
    doneCountEl.textContent = doneCount;
    const pct = totalWeight ? Math.round((doneWeight / totalWeight) * 100) : 0;
    percentEl.textContent = pct;
    barFillEl.style.width = pct + "%";

    let extrasDone = 0;
    for (const it of extras) { if (checked.has(it.id)) extrasDone++; }
    extrasDoneEl.textContent = extrasDone;
    extrasTotalEl.textContent = extras.length;
    const pctExtra = extras.length ? Math.round((extrasDone / extras.length) * 100) : 0;
    barFillExtrasEl.style.width = pctExtra + "%";
  }

  render();
})();
</script>
</body>
</html>
