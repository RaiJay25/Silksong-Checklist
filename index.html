<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Silksong 100% Checklist</title>
<style>
:root{
  /* Softer Hornet-inspired (muted crimson) */
  --bg:#7b2633;      /* deep rosewood */
  --fg:#fff7f7;      /* soft near-white text */
  --muted:#ffd6d6;   /* gentle rose for secondary text */

  --accent:#ff7a7a;  /* coral red accents */
  --accent2:#ffc2c2; /* light blush for gradients/hover */

  --card:#5a1c26;    /* darker card surface for contrast */
  --cardHover:#6a222d; /* hover surface */
  --edge:#9a3a49;    /* muted red borders */
  --edgeStrong:#b55362; /* stronger border on hover/focus */
  --chip:#66202a;    /* badge/chip background */
  --bar:#4c1720;     /* progress track */

  --extra1:#ff9aa5;  /* extras bar gradient 1 */
  --extra2:#ffd6d6;  /* extras bar gradient 2 */

  /* tool-color dots (kept readable on red) */
  --red:#ffe0e0;
  --blue:#a9cfff;
  --yellow:#ffe39a;
}

*{box-sizing:border-box}
html,body{
  margin:0;
  background:var(--bg);
  color:var(--fg);
  font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif
}

.container{max-width:1100px;margin:0 auto;padding:1rem}

/* Top bar */
.topbar{
  display:flex;gap:1rem;align-items:center;flex-wrap:wrap;
  border-bottom:2px solid var(--edge);padding-bottom:.75rem
}
.topbar h1{margin:0;font-size:1.15rem;letter-spacing:.2px}

/* Controls */
.controls{display:flex;gap:.5rem;flex-wrap:wrap;margin-left:auto;align-items:center}
.controls input[type="search"], .controls select{
  padding:.55rem .75rem;background:var(--card);border:1px solid var(--edge);color:var(--fg);border-radius:.55rem
}
.controls button{
  padding:.55rem .75rem;background:var(--card);border:1px solid var(--edge);color:var(--fg);
  border-radius:.55rem;cursor:pointer;transition:background .12s,border-color .12s,box-shadow .12s,transform .05s
}
.controls button:hover{border-color:var(--edgeStrong);background:var(--cardHover);box-shadow:0 0 0 2px rgba(255,145,145,.18)}
.controls button:active{transform:translateY(1px)}
.badge{background:var(--chip);border:1px solid var(--edge);border-radius:.5rem;padding:.25rem .5rem;color:var(--muted);font-size:.8rem}

/* Segmented filter */
.seg{display:inline-flex;border:1px solid var(--edge);border-radius:.55rem;overflow:hidden;background:var(--card)}
.seg button{background:transparent;border:none;padding:.55rem .7rem;color:var(--fg);cursor:pointer}
.seg button+button{border-left:1px solid var(--edge)}
.seg button.active{background:var(--cardHover)}

/* Progress bars */
.progress{display:grid;gap:.4rem;margin:.9rem 0}
.progress .label{color:var(--muted);font-size:.9rem}
.bar{height:10px;background:var(--bar);border-radius:999px;overflow:hidden;border:1px solid var(--edge)}
.bar-fill{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2));width:0%}

/* Cards & items */
.board{display:grid;gap:1rem}
.category{
  background:var(--card);border:1px solid var(--edge);border-radius:.9rem;overflow:hidden
}
.cat-head{display:flex;align-items:center;justify-content:space-between;padding:.8rem 1rem;cursor:pointer}
.cat-head h2{margin:0;font-size:1rem}
.cat-right{display:flex;align-items:center;gap:.35rem;flex-wrap:wrap}
.pillType{font-size:.7rem;padding:.2rem .45rem;border-radius:.45rem;border:1px solid var(--edge);background:var(--cardHover);color:var(--muted)}
.cat-count{color:var(--muted);font-size:.85rem;margin-left:.25rem}

.cat-items{padding:.2rem 1rem 1rem 1rem;display:grid;gap:.25rem}
.item{display:flex;align-items:center;gap:.6rem;padding:.45rem;border-radius:.6rem;transition:background .12s}
.item:hover{background:var(--cardHover)}
.item label{cursor:pointer}

/* Pills */
.item .meta{margin-left:auto;display:flex;gap:.4rem;align-items:center}
.item .pill{
  font-size:.75rem;padding:.15rem .45rem;border-radius:.45rem;
  background:var(--cardHover);border:1px solid var(--edge);color:var(--muted)
}
.item .color{border-color:var(--edgeStrong)}
.item .color.red{color:var(--red);border-color:var(--red)!important}
.item .color.blue{color:var(--blue);border-color:var(--blue)!important}
.item .color.yellow{color:var(--yellow);border-color:var(--yellow)!important}

/* Small buttons inside cards */
.smallbtn,.locbtn{
  font-size:.75rem;padding:.25rem .5rem;border-radius:.45rem;background:var(--cardHover);border:1px solid var(--edge);
  color:var(--muted);cursor:pointer;transition:background .12s,border-color .12s,box-shadow .12s
}
.smallbtn:hover,.locbtn:hover{border-color:var(--edgeStrong);background:var(--cardHover);box-shadow:0 0 0 2px rgba(255,145,145,.18)}

/* Checkboxes */
input[type="checkbox"]{
  width:18px;height:18px;accent-color:#ffe3e3;cursor:pointer;
  filter:drop-shadow(0 0 0 rgba(0,0,0,0));
}

/* Location details */
.loc{
  grid-column:1/-1;margin:.25rem 0 0 2rem;padding:.6rem .8rem;
  border-left:3px solid var(--accent);color:#ffe3e3;background:var(--cardHover);border-radius:.25rem
}
.loc a{color:#fff;text-decoration:underline}
.loc a:hover{opacity:.9}

.hidden{display:none!important}
.footer{margin:1.25rem 0;color:var(--muted);text-align:center;border-top:2px solid var(--edge);padding-top:1rem}

/* Subhead (tools split) */
hr.soft{border:none;border-top:1px dashed var(--edge);margin:.5rem 0}
.small{font-size:.85rem;color:var(--muted)}
.subhead{margin:.5rem 1rem 0;font-size:.85rem;color:#ffe3e3;display:flex;align-items:center;gap:.5rem}
.dot{width:.6rem;height:.6rem;border-radius:50%}
.dot.red{background:var(--red)} .dot.blue{background:var(--blue)} .dot.yellow{background:var(--yellow)}
</style>
</head>
<body>
<div class="container">
  <div class="topbar">
    <h1>Silksong Checklist</h1>
    <span id="totalBadge" class="badge">0 items</span>

    <div class="controls">
      <input id="search" type="search" placeholder="Search items‚Ä¶" aria-label="Search" />
      <select id="actFilter" aria-label="Filter by act">
        <option value="all">Act: All / Unknown</option>
      </select>
      <button id="groupByAct" type="button">Group by Act: Off</button>

      <!-- filter: All / 100% / Extras -->
      <div class="seg" role="group" aria-label="Filter by task type">
        <button id="filterAll"   type="button" class="active">All</button>
        <button id="filterMain"  type="button">100%</button>
        <button id="filterExtra" type="button">Extras</button>
      </div>

      <button id="expandAll" type="button">Expand All</button>
      <button id="collapseAll" type="button">Collapse All</button>
      <button id="exportBtn" type="button">Export</button>
      <input id="importFile" type="file" accept="application/json" hidden>
      <button id="importBtn" type="button">Import</button>
      <button id="resetBtn" type="button">Reset</button>
    </div>
  </div>

  <!-- Weighted 100% -->
  <div class="progress">
    <div class="label">
      <strong><span id="percent">0</span>%</strong> of weighted 100% ‚Ä¢
      <span id="doneCount">0</span>/<span id="totalCount">0</span> items checked
    </div>
    <div class="bar"><div id="barFill" class="bar-fill"></div></div>
  </div>

  <!-- Extras -->
  <div class="progress">
    <div class="label small">
      Extras (unweighted): <span id="extrasDone">0</span>/<span id="extrasTotal">0</span> items completed
    </div>
    <div class="bar"><div id="barFillExtras" class="bar-fill" style="background:linear-gradient(90deg,var(--extra1),var(--extra2))"></div></div>
  </div>

  <div id="board" class="board" aria-live="polite"></div>

  <div class="footer">
    <small>Progress is stored locally in your browser (localStorage). No data leaves your device.</small>
  </div>
</div>

<script>
(() => {
  const STORAGE_KEY = "silksong-checklist-v11";
  const ACT_LABEL = act => (act || act === 0) ? `Act ${act}` : "Act Unknown";

  /* ========= ORDER CONTROL (acquisition order) ========= */
  const categoryIndex = new Map(); // category name -> index
  const itemIndex = new Map();     // item id -> index
  function buildOrderMaps(DATA){
    let c=0, i=0;
    DATA.forEach(cat=>{
      if(!categoryIndex.has(cat.name)) categoryIndex.set(cat.name, c++);
      cat.items.forEach(it=> itemIndex.set(it.id, i++));
    });
  }

  // ======= DATA (edit to change order, acts, etc.) =======
  // Silk Hearts & Misc toward the bottom of weighted section. Sylphsong=Act 2, Everbloom=Act 3.
  const DATA = [
    /* ---- Needle Upgrades ‚Äî 4% ---- */
    { type:"main", name:"Needle Upgrades ‚Äî 4%", items:[
      { id:"needle_sharpened", name:"Sharpened Needle", weight:1, act:1 },
      { id:"needle_shining",   name:"Shining Needle",   weight:1, act:2 },
      { id:"needle_hivesteel", name:"Hivesteel Needle", weight:1, act:2 },
      { id:"needle_pale",      name:"Pale Steel Needle",weight:1, act:3 },
    ]},

    /* ---- Mask Shards ‚Äî 5% (20 √ó 0.25%) ---- */
    { type:"main", name:"Mask Shards ‚Äî 5% (order not indicative)", items:
      Array.from({length:20}, (_,k)=>({ id:`maskShard_${k+1}`, name:`Mask Shard ${k+1}`, weight:0.25, act:null }))
    },

    /* ---- Spool Fragments ‚Äî 9% (18 √ó 0.5%) ---- */
    { type:"main", name:"Spool Fragments ‚Äî 9%", items:
      Array.from({length:18}, (_,k)=>({ id:`spoolFrag_${k+1}`, name:`Spool Fragment ${k+1}`, weight:0.5, act:null }))
    },

    /* ---- Crafting Kit Upgrades ‚Äî 4% ---- */
    { type:"main", name:"Crafting Kit Upgrades ‚Äî 4%", items:[
      { id:"kit_1", name:"Crafting Kit Expansion I",  weight:1, act:1 },
      { id:"kit_2", name:"Crafting Kit Expansion II", weight:1, act:1 },
      { id:"kit_3", name:"Crafting Kit Expansion III",weight:1, act:2 },
      { id:"kit_4", name:"Crafting Kit Expansion IV", weight:1, act:2 },
    ]},

    /* ---- Tool Pouch Upgrades ‚Äî 4% ---- */
    { type:"main", name:"Tool Pouch Upgrades ‚Äî 4%", items:[
      { id:"pouch_1", name:"Tool Pouch Expansion I",  weight:1, act:1 },
      { id:"pouch_2", name:"Tool Pouch Expansion II", weight:1, act:1 },
      { id:"pouch_3", name:"Tool Pouch Expansion III",weight:1, act:2 },
      { id:"pouch_4", name:"Tool Pouch Expansion IV", weight:1, act:2 },
    ]},

    /* ---- Crests ‚Äî 6% ---- */
    { type:"main", name:"Crests ‚Äî 6%", items:[
      { id:"crest_reaper",    name:"Reaper",    weight:1, act:1 },
      { id:"crest_wanderer",  name:"Wanderer",  weight:1, act:1 },
      { id:"crest_beast",     name:"Beast",     weight:1, act:1 },
      { id:"crest_witch",     name:"Witch",     weight:1, act:2 },
      { id:"crest_architect", name:"Architect", weight:1, act:2 },
      { id:"crest_shaman",    name:"Shaman",    weight:1, act:3 },
    ]},

    /* ---- Silk Skills ‚Äî 6% ---- */
    { type:"main", name:"Silk Skills ‚Äî 6%", items:[
      { id:"skill_silkspear",   name:"Silkspear",     weight:1, act:1 },
      { id:"skill_threadstorm", name:"Thread Storm",  weight:1, act:1 },
      { id:"skill_sharpdart",   name:"Sharpdart",     weight:1, act:1 },
      { id:"skill_crossstitch", name:"Cross Stitch",  weight:1, act:1 },
      { id:"skill_runerage",    name:"Rune Rage",     weight:1, act:1 },
      { id:"skill_purenails",   name:"Pure Nails",    weight:1, act:3 },
    ]},

    /* ---- Tools ‚Äî 51% (Red / Blue / Yellow) ---- */
    { type:"main", name:"Tools ‚Äî 51% (Red / Blue / Yellow)", items:[
      /* RED */
      {id:"tool_straightpin",  name:"Straight Pin",   weight:1, act:null, color:"red"},
      {id:"tool_threefold",    name:"Threefold Pin",  weight:1, act:null, color:"red"},
      {id:"tool_stingshard",   name:"Sting Shard",    weight:1, act:null, color:"red"},
      {id:"tool_tacks",        name:"Tacks",          weight:1, act:null, color:"red"},
      {id:"tool_longpin",      name:"Longpin",        weight:1, act:null, color:"red"},
      {id:"tool_curveclaw",    name:"Curveclaw / Curvesickle", weight:1, act:null, color:"red"},
      {id:"tool_throwingring", name:"Throwing Ring",  weight:1, act:null, color:"red"},
      {id:"tool_pimpillo",     name:"Pimpillo",       weight:1, act:null, color:"red"},
      {id:"tool_conchcutter",  name:"Conchcutter",    weight:1, act:null, color:"red"},
      {id:"tool_silkshot",     name:"Silkshot",       weight:1, act:null, color:"red"},
      {id:"tool_delverdrill",  name:"Delver‚Äôs Drill", weight:1, act:null, color:"red"},
      {id:"tool_cogwheel",     name:"Cogwork Wheel",  weight:1, act:null, color:"red"},
      {id:"tool_cogfly",       name:"Cogfly",         weight:1, act:null, color:"red"},
      {id:"tool_rosarycannon", name:"Rosary Cannon",  weight:1, act:null, color:"red"},
      {id:"tool_voltvessels",  name:"Voltvessels",    weight:1, act:null, color:"red"},
      {id:"tool_flintslate",   name:"Flintslate",     weight:1, act:null, color:"red"},
      {id:"tool_fleabrew",     name:"Flea Brew",      weight:1, act:null, color:"red"},
      {id:"tool_plasmium",     name:"Plasmium Phial", weight:1, act:null, color:"red"},
      /* BLUE */
      {id:"tool_druidseye",    name:"Druid‚Äôs Eye / Druid‚Äôs Eyes", weight:1, act:null, color:"blue"},
      {id:"tool_magmbell",     name:"Magma Bell",          weight:1, act:null, color:"blue"},
      {id:"tool_wardingbell",  name:"Warding Bell",        weight:1, act:null, color:"blue"},
      {id:"tool_pollip",       name:"Pollip Pouch",        weight:1, act:null, color:"blue"},
      {id:"tool_fracturedmask",name:"Fractured Mask",      weight:1, act:null, color:"blue"},
      {id:"tool_multibinder",  name:"Multibinder",         weight:1, act:null, color:"blue"},
      {id:"tool_weavelight",   name:"Weavelight",          weight:1, act:null, color:"blue"},
      {id:"tool_sawtooth",     name:"Sawtooth Circlet",    weight:1, act:null, color:"blue"},
      {id:"tool_injectorband", name:"Injector Band",       weight:1, act:null, color:"blue"},
      {id:"tool_spoolext",     name:"Spool Extender",      weight:1, act:null, color:"blue"},
      {id:"tool_reservebind",  name:"Reserve Bind",        weight:1, act:null, color:"blue"},
      {id:"tool_clawmirror",   name:"Claw Mirror",         weight:1, act:null, color:"blue"},
      {id:"tool_memorycrystal",name:"Memory Crystal",      weight:1, act:null, color:"blue"},
      {id:"tool_snitchpick",   name:"Snitch Pick",         weight:1, act:null, color:"blue"},
      {id:"tool_voltfilament", name:"Volt Filament",       weight:1, act:null, color:"blue"},
      {id:"tool_quicksling",   name:"Quick Sling",         weight:1, act:null, color:"blue"},
      {id:"tool_wreathpurity", name:"Wreath of Purity",    weight:1, act:null, color:"blue"},
      {id:"tool_longclaw",     name:"Longclaw",            weight:1, act:null, color:"blue"},
      {id:"tool_wispfire",     name:"Wispfire Lantern",    weight:1, act:null, color:"blue"},
      {id:"tool_eggflealia",   name:"Egg of Flealia",      weight:1, act:null, color:"blue"},
      {id:"tool_pinbadge",     name:"Pin Badge",           weight:1, act:null, color:"blue"},
      /* YELLOW */
      {id:"tool_compass",      name:"Compass",             weight:1, act:null, color:"yellow"},
      {id:"tool_shardpendant", name:"Shard Pendant",       weight:1, act:null, color:"yellow"},
      {id:"tool_magnetite_brooch", name:"Magnetite Brooch", weight:1, act:null, color:"yellow"},
      {id:"tool_weightedbelt", name:"Weighted Belt",       weight:1, act:null, color:"yellow"},
      {id:"tool_barbed",       name:"Barbed Bracelet",     weight:1, act:null, color:"yellow"},
      {id:"tool_deadbug",      name:"Dead Bug‚Äôs Purse / Shell Satchel", weight:1, act:null, color:"yellow"},
      {id:"tool_magnetite_dice", name:"Magnetite Dice",    weight:1, act:null, color:"yellow"},
      {id:"tool_scuttlebrace", name:"Scuttlebrace",        weight:1, act:null, color:"yellow"},
      {id:"tool_wallcling",    name:"Ascendant‚Äôs Grip",    weight:1, act:null, color:"yellow"},
      {id:"tool_spiderstrings",name:"Spider Strings",      weight:1, act:null, color:"yellow"},
      {id:"tool_silkspeed",    name:"Silkspeed Anklets",   weight:1, act:null, color:"yellow"},
      {id:"tool_thiefsmark",   name:"Thief‚Äôs Mark",        weight:1, act:null, color:"yellow"},
    ]},

    /* ---- Silk Hearts ‚Äî 3% ---- */
    { type:"main", name:"Silk Hearts ‚Äî 3%", items:[
      { id:"sheart_1", name:"Silk Heart I",   weight:1, act:1 },
      { id:"sheart_2", name:"Silk Heart II",  weight:1, act:2 },
      { id:"sheart_3", name:"Silk Heart III", weight:1, act:2 },
    ]},

    /* ---- Misc ‚Äî 2% (Sylphsong Act 2, Everbloom Act 3) ---- */
    { type:"main", name:"Miscellaneous ‚Äî 2%", items:[
      { id:"misc_sylphsong", name:"Sylphsong", weight:1, act:2 },
      { id:"misc_everbloom", name:"Everbloom", weight:1, act:3 },
    ]},

    /* ===== EXTRAS (placeholders) ===== */
    { type:"extra", name:"Boss Fights", items:[ {id:"boss_placeholder1", name:"Boss ‚Äî TBD", act:null} ]},
    { type:"extra", name:"Wishes", items:[ {id:"wish_placeholder1", name:"Wish ‚Äî TBD", act:null} ]},
    { type:"extra", name:"The Materium", items:[ {id:"materium_placeholder1", name:"Materium Entry ‚Äî TBD", act:null} ]},
    { type:"extra", name:"Hunter Journal", items:[ {id:"journal_placeholder1", name:"Journal Entry ‚Äî TBD", act:null} ]},
    { type:"extra", name:"Keys", items:[ {id:"key_placeholder1", name:"Key ‚Äî TBD", act:null} ]},
    { type:"extra", name:"Relics", items:[ {id:"relic_placeholder1", name:"Relic ‚Äî TBD", act:null} ]},
    { type:"extra", name:"Memory Lockets", items:[ {id:"locket_placeholder1", name:"Memory Locket ‚Äî TBD", act:null} ]},
    { type:"extra", name:"Fleas", items:[ {id:"flea_placeholder1", name:"Flea ‚Äî TBD", act:null} ]},
    { type:"extra", name:"Pail Oil", items:[ {id:"oil_placeholder1", name:"Pail Oil ‚Äî TBD", act:null} ]},
    { type:"extra", name:"Craft Metal", items:[ {id:"metal_placeholder1", name:"Craft Metal ‚Äî TBD", act:null} ]},
  ];

  // Build order maps from your DATA definition
  buildOrderMaps(DATA);

  // -------- DOM lookups
  const board = document.getElementById("board");
  const searchEl = document.getElementById("search");
  const actFilterEl = document.getElementById("actFilter");
  const doneCountEl = document.getElementById("doneCount");
  const totalCountEl = document.getElementById("totalCount");
  const percentEl = document.getElementById("percent");
  const barFillEl = document.getElementById("barFill");
  const extrasDoneEl = document.getElementById("extrasDone");
  const extrasTotalEl = document.getElementById("extrasTotal");
  const barFillExtrasEl = document.getElementById("barFillExtras");
  const totalBadge = document.getElementById("totalBadge");

  // toolbar buttons
  const expandAllBtn = document.getElementById("expandAll");
  const collapseAllBtn = document.getElementById("collapseAll");
  const exportBtn = document.getElementById("exportBtn");
  const importBtn = document.getElementById("importBtn");
  const importFile = document.getElementById("importFile");
  const resetBtn = document.getElementById("resetBtn");
  const groupBtn = document.getElementById("groupByAct");
  const filterAllBtn   = document.getElementById("filterAll");
  const filterMainBtn  = document.getElementById("filterMain");
  const filterExtraBtn = document.getElementById("filterExtra");

  // -------- State
  let checked = new Set(JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]"));
  let groupByAct = false;
  let filterType = "all"; // "all" | "main" | "extra"

  function flatItems(){
    const list = [];
    DATA.forEach(cat=>{
      cat.items.forEach(it=>list.push({...it, category:cat.name, type:cat.type}));
    });
    return list;
  }

  // Populate Act filter
  (function initActFilter(){
    const acts = new Set(flatItems().map(i => i.act).filter(a => a || a === 0));
    [...acts].sort((a,b)=>a-b).forEach(a=>{
      const opt = document.createElement("option");
      opt.value = String(a);
      opt.textContent = ACT_LABEL(a);
      actFilterEl.appendChild(opt);
    });
  })();

  function render(){
    board.innerHTML = "";
    const items = flatItems();
    totalBadge.textContent = `${items.length} items`;

    const term = (searchEl.value || "").trim().toLowerCase();
    const actFilter = actFilterEl.value;

    // Filter by search / act / type
    let visible = items.filter(it=>{
      const s = it.name.toLowerCase();
      const matchesSearch =
        !term ||
        s.includes(term) ||
        it.category.toLowerCase().includes(term);
      const matchesAct = (actFilter === "all") || (String(it.act) === actFilter);
      const matchesType =
        filterType === "all"  ? true :
        filterType === "main" ? (it.type === "main") :
                                (it.type !== "main");
      return matchesSearch && matchesAct && matchesType;
    });

    // Group by Act or by Category ‚Äî preserve authored order
    if (groupByAct){
      const byAct = new Map();
      visible.forEach(i=>{
        const k = (i.act==null) ? "Unknown" : i.act;
        (byAct.get(k) || byAct.set(k,[]).get(k)).push(i);
      });
      const keys = [...byAct.keys()].sort((a,b)=>{
        if(a==="Unknown") return 1; if(b==="Unknown") return -1; return a-b;
      });
      keys.forEach(k=>{
        const title = (k==="Unknown") ? "Act Unknown" : `Act ${k}`;
        board.appendChild(sectionTitle(title));

        const byCat = groupBy(byAct.get(k), "category");
        [...Object.keys(byCat)]
          .sort((a,b) => (categoryIndex.get(a) ?? 9999) - (categoryIndex.get(b) ?? 9999))
          .forEach(catName=>{
            const itemsInCat = byCat[catName].slice()
              .sort((a,b) => (itemIndex.get(a.id) ?? 999999) - (itemIndex.get(b.id) ?? 999999));
            board.appendChild(renderCategory(catName, itemsInCat));
          });

        board.appendChild(document.createElement("hr")).className="soft";
      });
    } else {
      const byCat = groupBy(visible, "category");
      [...Object.keys(byCat)]
        .sort((a,b) => (categoryIndex.get(a) ?? 9999) - (categoryIndex.get(b) ?? 9999))
        .forEach(catName=>{
          const itemsInCat = byCat[catName].slice()
            .sort((a,b) => (itemIndex.get(a.id) ?? 999999) - (itemIndex.get(b.id) ?? 999999));
          board.appendChild(renderCategory(catName, itemsInCat));
        });
    }

    updateTotals();
  }

  function sectionTitle(text){
    const d = document.createElement("div");
    d.textContent = text;
    d.style.margin = ".25rem 0 .5rem";
    d.style.color = "var(--muted)";
    d.style.fontSize = ".95rem";
    return d;
  }

  function renderCategory(catName, items){
    const type = items[0]?.type || "main";
    const isTools = /Tools ‚Äî 51%/.test(catName);
    const card = document.createElement("section");
    card.className = "category";

    const head = document.createElement("div");
    head.className = "cat-head";
    const h2 = document.createElement("h2"); h2.textContent = catName;

    // right controls
    const right = document.createElement("div"); right.className="cat-right";
    const pill = document.createElement("span"); pill.className="pillType"; pill.textContent = (type==="main"?"Weighted":"Extra");
    const count = document.createElement("div"); count.className = "cat-count";
    const selectAll = document.createElement("button"); selectAll.type="button"; selectAll.className="smallbtn"; selectAll.title="Select all in this category"; selectAll.textContent="‚úì All";
    const deselectAll = document.createElement("button"); deselectAll.type="button"; deselectAll.className="smallbtn"; deselectAll.title="Deselect all in this category"; deselectAll.textContent="‚úó None";
    const toggle = document.createElement("button"); toggle.type="button"; toggle.className="smallbtn"; toggle.textContent="‚Äì";
    right.append(pill, count, selectAll, deselectAll, toggle);
    head.append(h2, right);

    const list = document.createElement("div");
    list.className = "cat-items";

    // handlers for select/deselect all in THIS category view
    function setAllInCategory(checkedState){
      const ids = items.map(i=>i.id);
      ids.forEach(id => checkedState ? checked.add(id) : checked.delete(id));
      persist(); render();
    }
    selectAll.addEventListener("click", (e)=>{ e.stopPropagation(); setAllInCategory(true); });
    deselectAll.addEventListener("click", (e)=>{ e.stopPropagation(); setAllInCategory(false); });

    if(isTools){
      list.appendChild(subHead("Red","red"));      renderItems(list, items.filter(i=>i.color==="red"));
      list.appendChild(subHead("Blue","blue"));    renderItems(list, items.filter(i=>i.color==="blue"));
      list.appendChild(subHead("Yellow","yellow"));renderItems(list, items.filter(i=>i.color==="yellow"));
    } else {
      renderItems(list, items);
    }

    head.addEventListener("click", (e)=>{
      if(e.target===head || e.target===toggle){
        list.classList.toggle("hidden");
        toggle.textContent = list.classList.contains("hidden") ? "+" : "‚Äì";
      }
    });

    card.append(head, list);
    updateCatCount(count, items);
    return card;
  }

  function subHead(txt, color){
    const sh = document.createElement("div");
    sh.className = "subhead";
    const dot = document.createElement("span"); dot.className = "dot " + color;
    const label = document.createElement("span"); label.textContent = txt;
    sh.append(dot,label);
    return sh;
  }

  function renderItems(container, items){
    items.forEach(it=>{
      const row = document.createElement("div"); row.className="item";
      const cb = document.createElement("input"); cb.type="checkbox"; cb.id=it.id; cb.checked = checked.has(it.id);
      const lab = document.createElement("label"); lab.setAttribute("for", it.id); lab.textContent = it.name;
      const meta = document.createElement("div"); meta.className="meta";
      if(it.weight!=null){ const w = document.createElement("span"); w.className="pill"; w.textContent = `${it.weight}%`; meta.appendChild(w); }
      const a = document.createElement("span"); a.className="pill"; a.textContent = ACT_LABEL(it.act); meta.appendChild(a);
      if(it.color){ const c = document.createElement("span"); c.className=`pill color ${it.color}`; c.textContent = it.color[0].toUpperCase()+it.color.slice(1); meta.appendChild(c); }
      const locBtn = document.createElement("button"); locBtn.type="button"; locBtn.className="locbtn"; locBtn.textContent = "üìç Location";
      meta.appendChild(locBtn);

      const details = document.createElement("div"); details.className="loc";
      details.innerHTML = (it.loc || "Location info not added yet.") + (it.url? ` ‚Äî <a target="_blank" rel="noopener" href="${it.url}">Open</a>` : "");

      function toggleDetails(){ details.style.display = (details.style.display==="block")? "none":"block"; }
      lab.addEventListener("click", toggleDetails);
      locBtn.addEventListener("click", toggleDetails);

      cb.addEventListener("change", ()=>{
        if(cb.checked) checked.add(it.id); else checked.delete(it.id);
        persist(); updateTotals();
      });

      row.append(cb, lab, meta);
      container.append(row, details);
    });
  }

  function updateCatCount(el, items){
    const done = items.filter(i=>checked.has(i.id)).length;
    el.textContent = `${done}/${items.length}`;
  }

  function updateTotals(){
    const items = flatItems();
    const main = items.filter(i=>i.type==="main");
    const extras = items.filter(i=>i.type!=="main");

    const totalItems = main.length;
    totalCountEl.textContent = totalItems;
    const totalWeight = main.reduce((s,i)=>s + (Number(i.weight)||0), 0);
    const doneMain = main.filter(i=>checked.has(i.id));
    const doneCount = doneMain.length;
    doneCountEl.textContent = doneCount;
    const doneWeight = doneMain.reduce((s,i)=>s + (Number(i.weight)||0), 0);
    const pct = totalWeight ? Math.round((doneWeight/totalWeight)*100) : 0;
    percentEl.textContent = pct;
    barFillEl.style.width = pct + "%";

    const extrasDone = extras.filter(i=>checked.has(i.id)).length;
    extrasDoneEl.textContent = extrasDone;
    extrasTotalEl.textContent = extras.length;
    const pctExtra = extras.length ? Math.round((extrasDone/extras.length)*100) : 0;
    barFillExtrasEl.style.width = pctExtra + "%";
  }

  function groupBy(list, key){
    return list.reduce((acc, cur)=>{
      const k = cur[key]; (acc[k] ||= []).push(cur); return acc;
    }, {});
  }

  function persist(){ localStorage.setItem(STORAGE_KEY, JSON.stringify([...checked])); }

  // Controls
  expandAllBtn.addEventListener("click", ()=>{
    document.querySelectorAll(".cat-items").forEach(el=>{
      el.classList.remove("hidden");
      const btn = el.previousElementSibling.querySelector(".smallbtn:last-child");
      if(btn) btn.textContent = "‚Äì";
    });
  });
  collapseAllBtn.addEventListener("click", ()=>{
    document.querySelectorAll(".cat-items").forEach(el=>{
      el.classList.add("hidden");
      const btn = el.previousElementSibling.querySelector(".smallbtn:last-child");
      if(btn) btn.textContent = "+";
    });
  });
  exportBtn.addEventListener("click", ()=>{
    const payload = { version:11, checked:[...checked] };
    const blob = new Blob([JSON.stringify(payload,null,2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = "silksong-progress.json"; a.click();
    URL.revokeObjectURL(url);
  });
  importBtn.addEventListener("click", ()=>importFile.click());
  importFile.addEventListener("change", async (e)=>{
    const f = e.target.files?.[0]; if(!f) return;
    try{
      const obj = JSON.parse(await f.text());
      if(!obj || !Array.isArray(obj.checked)) throw new Error("bad");
      checked = new Set(obj.checked);
      persist(); render(); alert("Import complete!");
    }catch(err){ alert("Import failed. Make sure you selected a valid export file."); }
    finally{ e.target.value = ""; }
  });
  resetBtn.addEventListener("click", ()=>{
    if(!confirm("Reset all progress?")) return;
    checked.clear(); persist(); render();
  });
  groupBtn.addEventListener("click", ()=>{
    groupByAct = !groupByAct;
    groupBtn.textContent = `Group by Act: ${groupByAct ? "On" : "Off"}`;
    render();
  });

  // segmented filter logic
  function setFilter(next){
    filterType = next;
    [filterAllBtn, filterMainBtn, filterExtraBtn].forEach(b=>b.classList.remove("active"));
    if(next==="all")  filterAllBtn.classList.add("active");
    if(next==="main") filterMainBtn.classList.add("active");
    if(next==="extra")filterExtraBtn.classList.add("active");
    render();
  }
  filterAllBtn.addEventListener("click",  ()=>setFilter("all"));
  filterMainBtn.addEventListener("click", ()=>setFilter("main"));
  filterExtraBtn.addEventListener("click",()=>setFilter("extra"));

  // Search + act filter
  document.getElementById("search").addEventListener("input", render);
  document.getElementById("actFilter").addEventListener("change", render);

  // Initial render
  render();
})();
</script>
</body>
</html>
